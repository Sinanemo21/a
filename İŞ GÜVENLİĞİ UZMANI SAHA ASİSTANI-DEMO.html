<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ä°SG Saha AsistanÄ± â€¢ Pro</title>
  <meta name="theme-color" content="#0b1220"/>
  <style>
    :root{
      --bg:#0b1220; --card:#101a33; --card2:#0f1a36; --muted:#98a9cb; --text:#eef3ff;
      --accent:#7aa7ff; --accent2:#31d07f; --warn:#ffcc66; --bad:#ff6b6b;
      --line:rgba(255,255,255,.10);
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --shadow2: 0 10px 26px rgba(0,0,0,.28);
      --radius:16px; --radius2:22px;
      --tap: rgba(122,167,255,.12);
    }
    [data-theme="light"]{
      --bg:#f5f7fb; --card:#ffffff; --card2:#ffffff; --muted:#52627f; --text:#0c1730;
      --accent:#2b61ff; --accent2:#0ea35a; --warn:#b27a00; --bad:#cc2d2d;
      --line:rgba(12,23,48,.10);
      --shadow: 0 14px 34px rgba(14,22,40,.12);
      --shadow2: 0 10px 22px rgba(14,22,40,.10);
      --tap: rgba(43,97,255,.10);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1100px 800px at 20% -10%,rgba(122,167,255,.18),transparent 55%),
        radial-gradient(900px 700px at 90% 0%,rgba(49,208,127,.12),transparent 60%),
        var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
    }
    button, input, select, textarea { font-family: inherit; }
    a{color:var(--accent)}
    .wrap{max-width:1240px;margin:0 auto;padding:16px 14px 92px}
    @media (min-width: 980px){ .wrap{padding-bottom:18px} }

    /* Top header */
    header{
      display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      padding:10px 6px 0;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:46px;height:46px;border-radius:16px;
      background:linear-gradient(135deg, rgba(122,167,255,.95), rgba(49,208,127,.9));
      box-shadow: var(--shadow);
      position:relative; overflow:hidden;
      flex:0 0 auto;
    }
    .logo:after{
      content:""; position:absolute; inset:-20px; transform:rotate(25deg);
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.35),transparent);
      animation:shine 3.8s infinite;
    }
    @keyframes shine{0%{left:-70%} 45%{left:130%} 100%{left:130%}}
    .title h1{margin:0;font-size:18px;letter-spacing:.2px}
    .title .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .sig{
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 12px;
      background:rgba(255,255,255,.04);
      box-shadow: var(--shadow2);
      display:flex; gap:10px; align-items:center;
      max-width: 100%;
    }
    .sig .mark{
      width:30px;height:30px;border-radius:12px;
      background:rgba(122,167,255,.22);
      border:1px solid rgba(122,167,255,.35);
      display:grid;place-items:center;font-weight:900;
    }
    .sig .txt{font-size:12px;line-height:1.25}
    .sig .txt b{font-weight:900}
    .sig .actions{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
    }
    .chip:active{transform:translateY(1px)}
    .chip.primary{background:rgba(122,167,255,.18);border-color:rgba(122,167,255,.45)}
    .chip.good{background:rgba(49,208,127,.14);border-color:rgba(49,208,127,.35)}
    .chip.warn{background:rgba(255,204,102,.14);border-color:rgba(255,204,102,.35)}

    /* Layout */
    .layout{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      margin-top:14px;
    }
    @media (min-width: 980px){
      .layout{grid-template-columns: 270px 1fr; align-items:start}
    }

    /* Sidebar */
    .side{
      position:sticky; top:12px;
      border:1px solid var(--line);
      border-radius:22px;
      background:rgba(255,255,255,.03);
      box-shadow: var(--shadow2);
      padding:10px;
      display:none;
    }
    @media (min-width: 980px){ .side{display:block} }
    .navbtn{
      width:100%;
      border:1px solid transparent;
      background:transparent;
      color:var(--text);
      border-radius:16px;
      padding:12px 12px;
      cursor:pointer;
      text-align:left;
      display:flex; align-items:center; gap:10px;
      font-weight:900;
      font-size:13px;
    }
    .navbtn small{color:var(--muted);font-weight:700}
    .navbtn:hover{background:rgba(255,255,255,.03)}
    .navbtn.active{background:rgba(122,167,255,.14);border-color:rgba(122,167,255,.40)}
    .ico{
      width:34px;height:34px;border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      display:grid;place-items:center;
      font-size:16px;
      flex:0 0 auto;
    }

    /* Mobile bottom nav */
    .bottom{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:rgba(16,26,51,.78);
      backdrop-filter: blur(14px);
      border-top:1px solid var(--line);
      display:flex;
      gap:10px;
      justify-content:space-between;
      z-index:20;
    }
    [data-theme="light"] .bottom{background:rgba(255,255,255,.78)}
    @media (min-width: 980px){ .bottom{display:none} }
    .btab{
      flex:1;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      border-radius:18px;
      padding:10px 10px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      display:flex; flex-direction:column; gap:4px; align-items:center; justify-content:center;
    }
    .btab.active{background:rgba(122,167,255,.16);border-color:rgba(122,167,255,.45)}
    .btab span{font-size:16px}

    /* Cards */
    .card{
      background:rgba(16,26,51,.88);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow: var(--shadow);
    }
    [data-theme="light"] .card{background:rgba(255,255,255,.88)}
    .card h2{margin:0;padding:16px 16px 0;font-size:15px}
    .pad{padding:14px 16px 16px}
    .grid2{display:grid;grid-template-columns: 1.1fr .9fr; gap:14px}
    @media (max-width: 980px){ .grid2{grid-template-columns:1fr} }

    /* Forms */
    label{display:block;color:var(--muted);font-size:12px;margin:10px 0 6px}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:92px;resize:vertical}
    .two{display:grid;grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width: 560px){ .two{grid-template-columns:1fr} }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:16px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
    }
    .btn.primary{background:rgba(122,167,255,.20);border-color:rgba(122,167,255,.55)}
    .btn.good{background:rgba(49,208,127,.16);border-color:rgba(49,208,127,.45)}
    .btn.danger{background:rgba(255,107,107,.16);border-color:rgba(255,107,107,.45)}
    .btn:active{transform:translateY(1px)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .hint{color:rgba(152,169,203,.95);font-size:12px;line-height:1.45}
    [data-theme="light"] .hint{color:rgba(82,98,127,.95)}
    .hidden{display:none!important}

    /* KPIs + Mini charts */
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
    @media (max-width: 820px){ .kpi{grid-template-columns:repeat(2,1fr)}}
    .k{
      padding:12px;border-radius:18px;border:1px solid var(--line);background:rgba(255,255,255,.03);
    }
    .k .v{font-size:18px;font-weight:1000}
    .k .t{color:var(--muted);font-size:12px;margin-top:2px}
    .bars{display:flex;gap:8px;align-items:flex-end;margin-top:10px}
    .bar{flex:1;border:1px solid var(--line);background:rgba(255,255,255,.03);border-radius:14px;padding:10px}
    .bar .h{height:84px;border-radius:12px;background:rgba(122,167,255,.16);border:1px solid rgba(122,167,255,.28)}
    .bar.good .h{background:rgba(49,208,127,.14);border-color:rgba(49,208,127,.28)}
    .bar.warn .h{background:rgba(255,204,102,.14);border-color:rgba(255,204,102,.28)}
    .bar.bad .h{background:rgba(255,107,107,.14);border-color:rgba(255,107,107,.28)}
    .bar .lab{margin-top:8px;font-size:12px;font-weight:900}
    .bar .num{color:var(--muted);font-size:12px;margin-top:2px}

    /* Tags */
    .tag{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:1000;border:1px solid var(--line);background:rgba(255,255,255,.03)}
    .risk-low{border-color:rgba(49,208,127,.35);background:rgba(49,208,127,.14)}
    .risk-mid{border-color:rgba(255,204,102,.35);background:rgba(255,204,102,.14)}
    .risk-high{border-color:rgba(255,107,107,.35);background:rgba(255,107,107,.14)}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--muted)}
    .right{margin-left:auto}

    /* Table */
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th{color:var(--muted);font-size:12px;text-align:left;padding:0 10px}
    td{padding:12px 10px;background:rgba(255,255,255,.03);border-top:1px solid var(--line);border-bottom:1px solid var(--line)}
    td:first-child{border-left:1px solid var(--line);border-top-left-radius:16px;border-bottom-left-radius:16px}
    td:last-child{border-right:1px solid var(--line);border-top-right-radius:16px;border-bottom-right-radius:16px}
    .nowrap{white-space:nowrap}

    /* Collapsible */
    details{
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(255,255,255,.02);
      padding:10px 12px;
    }
    details summary{
      cursor:pointer;
      font-weight:1000;
      list-style:none;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    details summary::-webkit-details-marker{display:none}
    details .body{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.45}

    /* Toast */
    .toast{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom:96px;
      background:rgba(16,26,51,.95);
      border:1px solid var(--line);
      padding:10px 12px;border-radius:16px;
      box-shadow: var(--shadow);
      color:var(--text);
      font-weight:900;font-size:13px;
      display:none; max-width: 92vw;
      z-index:30;
    }
    [data-theme="light"] .toast{background:rgba(255,255,255,.92)}
    @media (min-width: 980px){ .toast{bottom:18px} }
  </style>
</head>
<body>
  <div class="wrap" id="app" data-theme="dark">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <h1>Ä°SG Saha AsistanÄ± â€¢ Pro</h1>
          <div class="sub">Bulgu & Aksiyon â€¢ Kontrol Listeleri â€¢ Toolbox Talk â€¢ Offline Yedek</div>
        </div>
      </div>

      <div class="sig">
        <div class="mark" id="expertMark">B</div>
        <div class="txt">
          <div><b id="expertName">Fatih AKDENÄ°Z</b> <span id="expertTitle">Ä°Å GÃœVENLÄ°ÄÄ° UZMANI</span></div>
          <div><b id="expertClass">(B)</b> <span id="expertRoleLabel">TASARLAYAN</span></div>
          <div id="expertExtra" style="color:var(--muted);font-size:11px;margin-top:2px"></div>
        </div>
        <div class="actions">
          <button class="chip primary" id="toggleTheme">ğŸŒ— Tema</button>
          <button class="chip good" id="quickNew">ï¼‹ Bulgu</button>
          <button class="chip warn" id="quickPrint">ğŸ–¨ï¸ PDF</button>
        </div>
      </div>
    </header>

    <div class="layout">
      <aside class="side" aria-label="MenÃ¼">
        <button class="navbtn active" data-tab="dashboard"><span class="ico">ğŸ“Š</span><div>Dashboard<br/><small>Ã–zet & risk daÄŸÄ±lÄ±mÄ±</small></div></button>
        <button class="navbtn" data-tab="newFinding"><span class="ico">ğŸ“</span><div>Yeni Bulgu<br/><small>Sahada hÄ±zlÄ± kayÄ±t</small></div></button>
        <button class="navbtn" data-tab="checklists"><span class="ico">âœ…</span><div>Kontrol Listeleri<br/><small>Åantiye/ofis/depo</small></div></button>
        <button class="navbtn" data-tab="tools"><span class="ico">ğŸ§°</span><div>AraÃ§lar<br/><small>Toolbox talk & matris</small></div></button>
        <button class="navbtn" data-tab="actions"><span class="ico">ğŸ“Œ</span><div>Aksiyonlar<br/><small>Takip & filtre</small></div></button>
        <button class="navbtn" data-tab="notes"><span class="ico">ğŸ—’ï¸</span><div>Notlar<br/><small>GÃ¼nlÃ¼k kayÄ±t & kararlar</small></div></button>

        <button class="navbtn" data-tab="nearMiss"><span class="ico">âš ï¸</span><div>Ramak Kala<br/><small>Olay & kÃ¶k neden</small></div></button>
<button class="navbtn" data-tab="trainings"><span class="ico">ğŸ“</span><div>EÄŸitim / ToplantÄ±<br/><small>Toolbox + kayÄ±t</small></div></button>
<button class="navbtn" data-tab="equipment"><span class="ico">ğŸ§¯</span><div>Ekipman Kontrol<br/><small>TÃ¼p, kemer, merdiven</small></div></button>
<button class="navbtn" data-tab="exportImport"><span class="ico">ğŸ’¾</span><div>Yedek<br/><small>JSON / CSV</small></div></button>

        <button class="navbtn" data-tab="settings"><span class="ico">âš™ï¸</span><div>Ayarlar<br/><small>EÅŸikler & logo</small></div></button>
        <button class="navbtn" data-tab="help"><span class="ico">â„¹ï¸</span><div>KullanÄ±m<br/><small>HÄ±zlÄ± rehber</small></div></button>
      </aside>

      <main>
        <!-- DASHBOARD -->
        <section id="dashboard" class="grid2">
          <div class="card">
            <h2>BugÃ¼n Ne Var?</h2>
            <div class="pad">
              <div class="two">
                <div>
                  <label>Ä°ÅŸyeri / Åantiye</label>
                  <input id="siteName" placeholder="Ä°ÅŸyeri / Åantiye adÄ±" />
                </div>
                <div>
                  <label>Tarih</label>
                  <input id="siteDate" type="date" />
                </div>
              </div>

              <div class="two">
                <div>
                  <label>Ä°lgili Birim</label>
                  <input id="siteDept" placeholder="Ã–rn: Ä°nÅŸaat, Depo, Ofis, Ãœretim..." />
                </div>
                <div>
                  <label>Denetimi Yapan</label>
                  <input id="auditor" placeholder="Ad Soyad" />
                </div>
              </div>

              <div class="hr"></div>

              <div class="kpi">
                <div class="k"><div class="v" id="kTotal">0</div><div class="t">Toplam Bulgu</div></div>
                <div class="k"><div class="v" id="kOpen">0</div><div class="t">AÃ§Ä±k Aksiyon</div></div>
                <div class="k"><div class="v" id="kOverdue">0</div><div class="t">GecikmiÅŸ</div></div>
                <div class="k"><div class="v" id="kHigh">0</div><div class="t">YÃ¼ksek Risk</div></div>
              </div>

              <div class="hr"></div>

              <div class="row">
                <button class="btn primary" id="goNewFinding">+ Yeni Bulgu Gir</button>
                <button class="btn" id="goChecklists">Kontrol Listesine Git</button>
                <span class="tag right" id="storageTag">Offline â€¢ CihazÄ±nda</span>
              </div>

              <div class="hint" style="margin-top:10px">
                â€œPDFâ€ butonu tarayÄ±cÄ± yazdÄ±rma ekranÄ±nÄ± aÃ§ar. Oradan â€œPDF olarak kaydetâ€ seÃ§ebilirsin.
              </div>
            </div>
          </div>

          <div class="card">
            <h2>Risk DaÄŸÄ±lÄ±mÄ± & YaklaÅŸan Aksiyonlar</h2>
            <div class="pad">
              <div class="bars" aria-label="Risk daÄŸÄ±lÄ±mÄ±">
                <div class="bar good">
                  <div class="h" id="barLow" style="height:20px"></div>
                  <div class="lab">DÃ¼ÅŸÃ¼k</div>
                  <div class="num" id="nLow">0</div>
                </div>
                <div class="bar warn">
                  <div class="h" id="barMid" style="height:20px"></div>
                  <div class="lab">Orta</div>
                  <div class="num" id="nMid">0</div>
                </div>
                <div class="bar bad">
                  <div class="h" id="barHigh" style="height:20px"></div>
                  <div class="lab">YÃ¼ksek</div>
                  <div class="num" id="nHigh">0</div>
                </div>
              </div>

              <div class="hr"></div>

              <div class="two">
                <div>
                  <label>Filtre</label>
                  <select id="dashFilter">
                    <option value="all">Hepsi (aÃ§Ä±k)</option>
                    <option value="overdue">Sadece gecikmiÅŸ</option>
                    <option value="next7">Ã–nÃ¼mÃ¼zdeki 7 gÃ¼n</option>
                    <option value="high">YÃ¼ksek riskli</option>
                  </select>
                </div>
                <div>
                  <label>SÄ±ralama</label>
                  <select id="dashSort">
                    <option value="dueAsc">Termin: YakÄ±n â†’ Uzak</option>
                    <option value="riskDesc">Risk: YÃ¼ksek â†’ DÃ¼ÅŸÃ¼k</option>
                    <option value="newDesc">Yeni â†’ Eski</option>
                  </select>
                </div>
              </div>

              <div class="hr"></div>
              <div id="dashList" class="hint">HenÃ¼z aksiyon yok. â€œ+ Bulguâ€ ile baÅŸlayalÄ±m.</div>
            </div>
          </div>
        </section>

        <!-- NEW FINDING -->
        <section id="newFinding" class="grid2 hidden">
          <div class="card">
            <h2>Yeni Bulgu / Tehlike KaydÄ±</h2>
            <div class="pad">
              <div class="two">
                <div>
                  <label>Kategori</label>
                  <select id="cat"></select>
                </div>
                <div>
                  <label>Lokasyon</label>
                  <input id="loc" placeholder="Ã–rn: 3. kat, kazan dairesi, depo koridoru..." />
                </div>
              </div>

              <label>Bulgu / Tehlike TanÄ±mÄ±</label>
              <textarea id="desc" placeholder="Ne gÃ¶rdÃ¼n? (net, Ã¶lÃ§Ã¼lebilir)"></textarea>

              <label>Ã–nerilen Ã–nlem (Kontrol Tedbiri)</label>
              <textarea id="control" placeholder="Ne yapÄ±lmalÄ±? (mÃ¼hendislik / idari / KKD sÄ±rasÄ±)"></textarea>

              <div class="two">
                <div>
                  <label>OlasÄ±lÄ±k (1-5)</label>
                  <select id="p"></select>
                </div>
                <div>
                  <label>Åiddet (1-5)</label>
                  <select id="s"></select>
                </div>
              </div>

              <div class="two">
                <div>
                  <label>Sorumlu</label>
                  <input id="owner" placeholder="Ã–rn: Åantiye Åefi / Ä°K / BakÄ±m..." />
                </div>
                <div>
                  <label>Termin</label>
                  <input id="due" type="date" />
                </div>
              </div>

              <label>FotoÄŸraf (opsiyonel â€¢ 1 adet)</label>
              <input id="photo" type="file" accept="image/*" />
              <div class="hint">Not: FotoÄŸraf data olarak saklanÄ±r. Ã‡ok bÃ¼yÃ¼k fotoÄŸraf seÃ§ersen yavaÅŸlayabilir (mÃ¼mkÃ¼nse kÃ¼Ã§Ã¼k Ã§ek).</div>

              <div class="row" style="margin-top:10px">
                <button class="btn primary" id="saveFinding">Kaydet</button>
                <button class="btn" id="prefillFromTemplate">Åablondan Doldur</button>
                <button class="btn danger" id="clearFinding">Temizle</button>
                <span class="tag right" id="riskTag">Risk: 9 (Orta)</span>
              </div>

              <details style="margin-top:12px">
                <summary>ğŸ“Œ Ä°pucu: Kontrol hiyerarÅŸisi <span class="badge">MÃ¼hendislik â†’ Ä°dari â†’ KKD</span></summary>
                <div class="body">
                  Ã–nlemleri yazarken â€œkaynaÄŸÄ±nda yok etmeâ€ ve â€œtoplu korumaâ€ Ã¶ncelikli dÃ¼ÅŸÃ¼n. KKD genellikle son basamak.
                </div>
              </details>
            </div>
          </div>

          <div class="card">
            <h2>Son Eklenenler</h2>
            <div class="pad">
              <div id="recent" class="hint">HenÃ¼z kayÄ±t yok.</div>
            </div>
          </div>
        </section>

        <!-- CHECKLISTS -->
        <section id="checklists" class="grid2 hidden">
          <div class="card">
            <h2>HazÄ±r Kontrol Listeleri</h2>
            <div class="pad">
              <div class="two">
                <div>
                  <label>Liste SeÃ§</label>
                  <select id="clSelect"></select>
                </div>
                <div>
                  <label>Arama</label>
                  <input id="clSearch" placeholder="liste iÃ§inde ara..." />
                </div>
              </div>

              <div class="row" style="margin-top:10px">
                <button class="btn primary" id="addFailedToFindings">â€œUygunsuzâ€larÄ± Bulguya Ekle</button>
                <button class="btn" id="resetChecklist">Listeyi SÄ±fÄ±rla</button>
                <button class="btn" id="quickSummary">Ã–zet Ã‡Ä±kar</button>
              </div>

              <div class="hr"></div>
              <div id="clItems"></div>
              <div class="hr"></div>
              <div class="hint">
                Sahada â€œUygunsuzâ€ iÅŸaretlediklerini tek tuÅŸla bulguya dÃ¶nÃ¼ÅŸtÃ¼rebilirsin. â€œÃ–zetâ€ ile Uygun/Uygunsuz sayÄ±sÄ± Ã§Ä±kar.
              </div>
            </div>
          </div>

          <div class="card">
            <h2>HÄ±zlÄ± Åablonlar</h2>
            <div class="pad">
              <div class="hint">
                Åablonlar â€œYeni Bulguâ€ ekranÄ±nda otomatik doldurma iÃ§indir. Ä°stersen Ayarlarâ€™dan kendi ÅŸablonlarÄ±nÄ± ekleyebilirsin.
              </div>
              <div class="hr"></div>
              <div id="tplList"></div>
            </div>
          </div>
        </section>

        <!-- TOOLS -->
        <section id="tools" class="grid2 hidden">
          <div class="card">
            <h2>Toolbox Talk (GÃ¼nlÃ¼k 5 Dakika)</h2>
            <div class="pad">
              <div class="two">
                <div>
                  <label>Konu</label>
                  <select id="tbTopic">
                    <option value="YÃ¼ksekte Ã‡alÄ±ÅŸma">YÃ¼ksekte Ã‡alÄ±ÅŸma</option>
                    <option value="Elektrik">Elektrik</option>
                    <option value="Elle TaÅŸÄ±ma">Elle TaÅŸÄ±ma</option>
                    <option value="KaldÄ±rma OperasyonlarÄ±">KaldÄ±rma OperasyonlarÄ±</option>
                    <option value="Kimyasal">Kimyasal</option>
                    <option value="YangÄ±n">YangÄ±n</option>
                    <option value="Ä°skele / Platform">Ä°skele / Platform</option>
                    <option value="Genel Saha Disiplini">Genel Saha Disiplini</option>
                  </select>
                </div>
                <div>
                  <label>Ek Not</label>
                  <input id="tbNote" placeholder="Ã–rn: bugÃ¼n vinÃ§ Ã§alÄ±ÅŸmasÄ± var / rÃ¼zgar yÃ¼ksek..." />
                </div>
              </div>

              <div class="row" style="margin-top:10px">
                <button class="btn primary" id="genToolbox">Toolbox Metni Ãœret</button>
                <button class="btn" id="copyToolbox">Kopyala</button>
              </div>

              <div class="hr"></div>
              <label>Toolbox Metni</label>
              <textarea id="tbOut" readonly></textarea>

              <details style="margin-top:12px">
                <summary>ğŸ‘¥ KatÄ±lÄ±m imzasÄ± Ã¶nerisi <span class="badge">Saha</span></summary>
                <div class="body">
                  KÄ±sa form: Tarih â€¢ Konu â€¢ KatÄ±lÄ±mcÄ± ad/soyad â€¢ Ä°mza. PDF rapora eklemek iÃ§in Ã§Ä±ktÄ± alabilirsin.
                </div>
              </details>
            </div>
          </div>

          <div class="card">
            <h2>Risk Matris AyarÄ± & HÄ±zlÄ± Hesap</h2>
            <div class="pad">
              <div class="two">
                <div>
                  <label>EÅŸikler</label>
                  <div class="hint">VarsayÄ±lan: 1-5 DÃ¼ÅŸÃ¼k â€¢ 6-12 Orta â€¢ 15-25 YÃ¼ksek</div>
                  <div class="two" style="margin-top:8px">
                    <div>
                      <label style="margin-top:0">DÃ¼ÅŸÃ¼k max</label>
                      <input id="thrLow" type="number" min="1" max="25"/>
                    </div>
                    <div>
                      <label style="margin-top:0">Orta max</label>
                      <input id="thrMid" type="number" min="1" max="25"/>
                    </div>
                  </div>
                  <div class="row" style="margin-top:10px">
                    <button class="btn good" id="saveThresholds">EÅŸikleri Kaydet</button>
                    <button class="btn" id="resetThresholds">VarsayÄ±lan</button>
                  </div>
                </div>

                <div>
                  <label>HÄ±zlÄ± Hesap</label>
                  <div class="two">
                    <div>
                      <label style="margin-top:0">OlasÄ±lÄ±k</label>
                      <select id="qp"></select>
                    </div>
                    <div>
                      <label style="margin-top:0">Åiddet</label>
                      <select id="qs"></select>
                    </div>
                  </div>
                  <div class="hr"></div>
                  <div class="row">
                    <span class="tag" id="qRisk">Risk: 9 (Orta)</span>
                    <span class="badge">Not: Bulgu kaydÄ±na otomatik yazmaz</span>
                  </div>
                </div>
              </div>

              <div class="hr"></div>
              <details>
                <summary>ğŸ“’ Mini rehber (termin Ã¶nerisi) <span class="badge">Pratik</span></summary>
                <div class="body">
                  YÃ¼ksek risk: mÃ¼mkÃ¼nse aynÄ± gÃ¼n / derhal kapat. Orta risk: 7-14 gÃ¼n iÃ§inde. DÃ¼ÅŸÃ¼k risk: planlÄ± iyileÅŸtirme.
                </div>
              </details>
            </div>
          </div>
        </section>

        <!-- ACTIONS -->
        <section id="actions" class="card hidden">
          <h2>Aksiyon Takip</h2>
          <div class="pad">
            <div class="two">
              <div>
                <label>Durum</label>
                <select id="fStatus">
                  <option value="all">Hepsi</option>
                  <option value="open">AÃ§Ä±k</option>
                  <option value="done">KapalÄ±</option>
                </select>
              </div>
              <div>
                <label>Arama</label>
                <input id="fSearch" placeholder="kategori / lokasyon / tanÄ±m / sorumlu..." />
              </div>
            </div>

            <div class="two">
              <div>
                <label>Risk</label>
                <select id="fRisk">
                  <option value="all">Hepsi</option>
                  <option value="high">YÃ¼ksek</option>
                  <option value="mid">Orta</option>
                  <option value="low">DÃ¼ÅŸÃ¼k</option>
                </select>
              </div>
              <div>
                <label>SÄ±ralama</label>
                <select id="fSort">
                  <option value="riskDesc">Risk: YÃ¼ksek â†’ DÃ¼ÅŸÃ¼k</option>
                  <option value="dueAsc">Termin: YakÄ±n â†’ Uzak</option>
                  <option value="newDesc">Yeni â†’ Eski</option>
                </select>
              </div>
            </div>

            <div class="hr"></div>

            <div style="overflow:auto">
              <table>
                <thead>
                  <tr>
                    <th>Risk</th>
                    <th>Kategori</th>
                    <th>Lokasyon / TanÄ±m</th>
                    <th>Sorumlu</th>
                    <th>Termin</th>
                    <th>Durum</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="actionRows"></tbody>
              </table>
            </div>

            <div class="hint">KayÄ±tlar sadece bu cihazda saklanÄ±r. DÃ¼zenli olarak â€œYedekâ€ menÃ¼sÃ¼nden JSON indir.</div>
          </div>
        </section>

        
        <!-- NOTES -->
        <section id="notes" class="grid2 hidden">
          <div class="card">
            <h2>Notlar / GÃ¼nlÃ¼k KayÄ±t</h2>
            <div class="pad">
              <div class="two">
                <div>
                  <label>Tarih</label>
                  <input id="noteDate" type="date" />
                </div>
                <div>
                  <label>Etiket (opsiyonel)</label>
                  <input id="noteTag" placeholder="Ã–rn: ToplantÄ±, Denetim, Ä°SG Kurulu..." />
                </div>
              </div>

              <label>BaÅŸlÄ±k</label>
              <input id="noteTitle" placeholder="KÄ±sa baÅŸlÄ±k" />

              <label>Not / Karar / GÃ¶zlem</label>
              <textarea id="noteBody" placeholder="Ã–rn: BugÃ¼n ÅŸu uygunsuzluklar tespit edildi... alÄ±nan aksiyonlar... sorumlular..."></textarea>

              <div class="row" style="margin-top:10px">
                <button class="btn primary" id="saveNote">Kaydet</button>
                <button class="btn" id="copyNote">Kopyala</button>
                <button class="btn danger" id="clearNote">Temizle</button>
                <button class="btn" id="printNotes">YazdÄ±r / PDF</button>
              </div>

              <div class="hint" style="margin-top:10px">
                Ä°pucu: ToplantÄ±/Toolbox notlarÄ±nÄ± burada biriktirip PDF alabilirsin.
              </div>
            </div>
          </div>

          <div class="card">
            <h2>Son Notlar</h2>
            <div class="pad">
              <div id="noteRecent" class="hint">HenÃ¼z not yok.</div>
            </div>
          </div>
        </section>


<!-- NEAR MISS -->
<section id="nearMiss" class="grid2 hidden">
  <div class="card">
    <h2>Ramak Kala / Tehlikeli Olay KaydÄ±</h2>
    <div class="pad">
      <div class="two">
        <div>
          <label>Olay Tarihi</label>
          <input id="nmDate" type="date" />
        </div>
        <div>
          <label>Lokasyon</label>
          <input id="nmLoc" placeholder="Lokasyon" />
        </div>
      </div>

      <label>Olay TanÄ±mÄ± (Ne oldu?)</label>
      <textarea id="nmDesc" placeholder="KÄ±sa ve net anlat..."></textarea>

      <div class="two">
        <div>
          <label>Potansiyel SonuÃ§</label>
          <select id="nmCons">
            <option value="Ä°lk yardÄ±m gerektirmeyen">Ä°lk yardÄ±m gerektirmeyen</option>
            <option value="Ä°lk yardÄ±m">Ä°lk yardÄ±m</option>
            <option value="KayÄ±p gÃ¼nlÃ¼ yaralanma">KayÄ±p gÃ¼nlÃ¼ yaralanma</option>
            <option value="AÄŸÄ±r yaralanma">AÄŸÄ±r yaralanma</option>
            <option value="Ã–lÃ¼mcÃ¼l">Ã–lÃ¼mcÃ¼l</option>
            <option value="Maddi hasar">Maddi hasar</option>
          </select>
        </div>
        <div>
          <label>Olay TÃ¼rÃ¼</label>
          <select id="nmType">
            <option value="DÃ¼ÅŸme">DÃ¼ÅŸme</option>
            <option value="DÃ¼ÅŸen cisim">DÃ¼ÅŸen cisim</option>
            <option value="Elektrik">Elektrik</option>
            <option value="KaldÄ±rma">KaldÄ±rma</option>
            <option value="Makine">Makine</option>
            <option value="Kimyasal">Kimyasal</option>
            <option value="YangÄ±n">YangÄ±n</option>
            <option value="Trafik / forklift">Trafik / forklift</option>
            <option value="DiÄŸer">DiÄŸer</option>
          </select>
        </div>
      </div>

      <label>Ä°lk MÃ¼dahale / AlÄ±nan AnlÄ±k Ã–nlem</label>
      <textarea id="nmImmediate" placeholder="Ã–rn: alan izole edildi, enerji kesildi, ekipman kullanÄ±mdan kaldÄ±rÄ±ldÄ±..."></textarea>

      <label>KÃ¶k Neden (kÄ±saca)</label>
      <textarea id="nmRoot" placeholder="Ã–rn: prosedÃ¼r eksikliÄŸi, denetim zayÄ±f, ekipman uygunsuz, eÄŸitim ihtiyacÄ±..."></textarea>

      <div class="two">
        <div>
          <label>Sorumlu</label>
          <input id="nmOwner" placeholder="Sorumlu" />
        </div>
        <div>
          <label>Takip Termin</label>
          <input id="nmDue" type="date" />
        </div>
      </div>

      <label>FotoÄŸraf (opsiyonel â€¢ 1 adet)</label>
      <input id="nmPhoto" type="file" accept="image/*" />
      <div class="hint">Ramak kala kayÄ±tlarÄ±, iyileÅŸtirme fÄ±rsatÄ±dÄ±r. SuÃ§lu aramak yerine sistem iyileÅŸtirmeye odaklan.</div>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="saveNearMiss">Kaydet</button>
        <button class="btn danger" id="clearNearMiss">Temizle</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Son Ramak Kala KayÄ±tlarÄ±</h2>
    <div class="pad">
      <div id="nmRecent" class="hint">HenÃ¼z kayÄ±t yok.</div>
    </div>
  </div>
</section>

<!-- TRAININGS -->
<section id="trainings" class="grid2 hidden">
  <div class="card">
    <h2>EÄŸitim / ToplantÄ± KaydÄ±</h2>
    <div class="pad">
      <div class="two">
        <div>
          <label>Tarih</label>
          <input id="trDate" type="date" />
        </div>
        <div>
          <label>TÃ¼r</label>
          <select id="trType">
            <option value="Toolbox Talk">Toolbox Talk</option>
            <option value="Ä°SG EÄŸitimi">Ä°SG EÄŸitimi</option>
            <option value="Acil Durum TatbikatÄ±">Acil Durum TatbikatÄ±</option>
            <option value="ToplantÄ±">ToplantÄ±</option>
          </select>
        </div>
      </div>

      <label>Konu</label>
      <input id="trTopic" placeholder="Konu" />

      <div class="two">
        <div>
          <label>EÄŸitimi Veren</label>
          <input id="trTrainer" placeholder="Ad Soyad" />
        </div>
        <div>
          <label>KatÄ±lÄ±mcÄ± SayÄ±sÄ±</label>
          <input id="trCount" type="number" min="0" placeholder="0" />
        </div>
      </div>

      <div class="two">
        <div>
          <label>SÃ¼re (dk)</label>
          <input id="trMin" type="number" min="0" placeholder="0" />
        </div>
        <div>
          <label>Yer</label>
          <input id="trLoc" placeholder="Yer" />
        </div>
      </div>

      <label>Notlar</label>
      <textarea id="trNotes" placeholder="AlÄ±nan kararlar, gÃ¶zlemler, aksiyonlar..."></textarea>

      <label>FotoÄŸraf (opsiyonel â€¢ 1 adet)</label>
      <input id="trPhoto" type="file" accept="image/*" />

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="saveTraining">Kaydet</button>
        <button class="btn" id="printTraining">YazdÄ±r / PDF</button>
        <button class="btn danger" id="clearTraining">Temizle</button>
      </div>

      <details style="margin-top:12px">
        <summary>ğŸ“Œ Pratik: katÄ±lÄ±m listesi <span class="badge">Åablon</span></summary>
        <div class="body">
          Tarih â€¢ Konu â€¢ Yer â€¢ EÄŸitimi veren â€¢ KatÄ±lÄ±mcÄ± ad/soyad â€¢ Ä°mza. Bu sayfayÄ± PDF alÄ±p ek yapabilirsin.
        </div>
      </details>
    </div>
  </div>

  <div class="card">
    <h2>Son EÄŸitim / ToplantÄ±lar</h2>
    <div class="pad">
      <div id="trRecent" class="hint">HenÃ¼z kayÄ±t yok.</div>
    </div>
  </div>
</section>

<!-- EQUIPMENT -->
<section id="equipment" class="grid2 hidden">
  <div class="card">
    <h2>Ekipman Kontrol (HÄ±zlÄ±)</h2>
    <div class="pad">
      <div class="two">
        <div>
          <label>Ekipman TÃ¼rÃ¼</label>
          <select id="eqType"></select>
        </div>
        <div>
          <label>Kimlik / Seri No</label>
          <input id="eqId" placeholder="Seri no / lokasyon kodu" />
        </div>
      </div>

      <div class="two">
        <div>
          <label>Kontrol Tarihi</label>
          <input id="eqDate" type="date" />
        </div>
        <div>
          <label>Bir Sonraki Kontrol</label>
          <input id="eqNext" type="date" />
        </div>
      </div>

      <div class="hr"></div>
      <div id="eqItems"></div>

      <label>SonuÃ§</label>
      <select id="eqResult">
        <option value="Uygun">Uygun</option>
        <option value="ÅartlÄ± uygun">ÅartlÄ± uygun</option>
        <option value="Uygunsuz (kullanma)">Uygunsuz (kullanma)</option>
      </select>

      <label>Not</label>
      <textarea id="eqNote" placeholder="Tespit/Ã¶neri..."></textarea>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="saveEq">Kaydet</button>
        <button class="btn danger" id="clearEq">Temizle</button>
      </div>

      <div class="hint" style="margin-top:10px">
        Bu bÃ¶lÃ¼m â€œhÄ±zlÄ± saha kontrolÃ¼â€ iÃ§indir. Resmi periyodik kontrol yÃ¼kÃ¼mlÃ¼lÃ¼kleri iÃ§in ayrÄ±ca kayÄ±t tutulmalÄ±dÄ±r.
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Son Ekipman Kontrolleri</h2>
    <div class="pad">
      <div id="eqRecent" class="hint">HenÃ¼z kayÄ±t yok.</div>
    </div>
  </div>
</section>
<!-- EXPORT/IMPORT -->
        <section id="exportImport" class="grid2 hidden">
          <div class="card">
            <h2>DÄ±ÅŸa Aktar</h2>
            <div class="pad">
              <div class="row">
                <button class="btn primary" id="exportJson">JSON Yedek Ä°ndir</button>
                <button class="btn" id="exportCsv">CSV Ä°ndir</button>
                <button class="btn" id="copyJson">JSON Kopyala</button>
              </div>
              <div class="hr"></div>
              <label>Ã–nizleme (JSON)</label>
              <textarea id="exportPreview" readonly></textarea>
              <div class="hint">JSON yedeÄŸi baÅŸka bir telefona/PCâ€™ye taÅŸÄ±yÄ±p â€œÄ°Ã§e Aktarâ€ ile geri yÃ¼kleyebilirsin.</div>
            </div>
          </div>

          <div class="card">
            <h2>Ä°Ã§e Aktar</h2>
            <div class="pad">
              <label>JSON YapÄ±ÅŸtÄ±r</label>
              <textarea id="importBox" placeholder="Buraya JSON yedeÄŸini yapÄ±ÅŸtÄ±r..."></textarea>
              <div class="row">
                <button class="btn good" id="importJson">Ä°Ã§e Aktar (BirleÅŸtir)</button>
                <button class="btn danger" id="wipeAll">TÃ¼m KayÄ±tlarÄ± Sil</button>
              </div>
              <div class="hint">â€œBirleÅŸtirâ€ aynÄ± kaydÄ± tekrar eklemez (id bazlÄ±). Silme iÅŸlemi geri alÄ±namaz.</div>
            </div>
          </div>
        </section>

        <!-- SETTINGS -->
        
        <section id="settings" class="grid2 hidden">
          <div class="card">
            <h2>Ä°SG UzmanÄ± Bilgileri</h2>
            <div class="pad">
              <div class="two">
                <div>
                  <label>Ad Soyad</label>
                  <input id="expName" placeholder="Ã–rn: Fatih AKDENÄ°Z" />
                </div>
                <div>
                  <label>Belge SÄ±nÄ±fÄ±</label>
                  <select id="expClass">
                    <option value="A">(A)</option>
                    <option value="B">(B)</option>
                    <option value="C">(C)</option>
                  </select>
                </div>
              </div>

              <div class="two">
                <div>
                  <label>Belge No (opsiyonel)</label>
                  <input id="expCert" placeholder="Ã–rn: 12.34.5678" />
                </div>
                <div>
                  <label>OSGB / Firma (opsiyonel)</label>
                  <input id="expOrg" placeholder="Ã–rn: X OSGB / Y Ä°nÅŸaat" />
                </div>
              </div>

              <label>Ä°letiÅŸim (opsiyonel)</label>
              <input id="expContact" placeholder="Ã–rn: 05xx xxx xx xx â€¢ eâ€‘posta" />

              <div class="row" style="margin-top:10px">
                <button class="btn good" id="saveExpert">Kaydet</button>
                <button class="btn danger" id="clearExpert">Temizle</button>
              </div>

              <div class="hint" style="margin-top:10px">
                Bu bilgiler Ã¼st baÅŸlÄ±ktaki imza alanÄ±nda â€œ(A/B/C) TASARLAYANâ€ olarak gÃ¶rÃ¼nÃ¼r ve cihazÄ±nda saklanÄ±r.
              </div>
            </div>
          </div>

          <div class="card">
            <h2>GÃ¶rÃ¼nÃ¼m & Marka</h2>
            <div class="pad">
              <label>BaÅŸlÄ±k (opsiyonel)</label>
              <input id="brandTitle" placeholder="Ã–rn: Ä°SG Takip Paneli" />
              <label>Logo (opsiyonel â€¢ kÃ¼Ã§Ã¼k)</label>
              <input id="brandLogo" type="file" accept="image/*" />
              <div class="row" style="margin-top:10px">
                <button class="btn good" id="saveBrand">Kaydet</button>
                <button class="btn danger" id="clearBrand">Temizle</button>
              </div>
              <div class="hint" style="margin-top:10px">
                Logo yalnÄ±zca bu cihazda saklanÄ±r (offline). PDF Ã§Ä±ktÄ±sÄ±nda baÅŸlÄ±k/isim gÃ¶rÃ¼nÃ¼r.
              </div>
            </div>
          </div>

          <div class="card">
            <h2>Åablon YÃ¶netimi</h2>
            <div class="pad">
              <div class="hint">Kendi bulgu ÅŸablonlarÄ±nÄ± ekle (Ã¶r. â€œKapalÄ± alanâ€ / â€œLOTOâ€).</div>
              <div class="hr"></div>

              <div class="two">
                <div>
                  <label>Åablon AdÄ±</label>
                  <input id="tName" placeholder="Ã–rn: LOTO eksik" />
                </div>
                <div>
                  <label>Kategori</label>
                  <input id="tCat" placeholder="Ã–rn: Makine / Elektrik" />
                </div>
              </div>
              <label>Bulgu</label>
              <textarea id="tDesc" placeholder="Åablon bulgu metni..."></textarea>
              <label>Ã–neri</label>
              <textarea id="tCtrl" placeholder="Åablon Ã¶neri metni..."></textarea>
              <div class="two">
                <div>
                  <label>OlasÄ±lÄ±k</label>
                  <select id="tP"></select>
                </div>
                <div>
                  <label>Åiddet</label>
                  <select id="tS"></select>
                </div>
              </div>
              <div class="row" style="margin-top:10px">
                <button class="btn primary" id="addTemplate">Åablon Ekle</button>
                <button class="btn" id="resetTemplates">VarsayÄ±lana DÃ¶n</button>
              </div>

              <div class="hr"></div>
              <div id="userTplList" class="hint">HenÃ¼z Ã¶zel ÅŸablon yok.</div>
            </div>
          </div>
        </section>

        <!-- HELP -->
        <section id="help" class="card hidden">
          <h2>KullanÄ±m (HÄ±zlÄ±)</h2>
          <div class="pad">
            <div class="hint">
              <b>1)</b> Dashboardâ€™dan iÅŸyeri bilgilerini gir.<br/>
              <b>2)</b> â€œYeni Bulguâ€ ile tespitleri kaydet, termin/sorumlu ata.<br/>
              <b>3)</b> â€œKontrol Listeleriâ€nden hÄ±zlÄ± denetim yap, uygunsuzlarÄ± tek tuÅŸla bulguya Ã§evir.<br/>
              <b>4)</b> â€œAraÃ§larâ€ â†’ Toolbox talk ile gÃ¼nlÃ¼k 5 dk konuÅŸma metni Ã¼ret.<br/>
              <b>5)</b> â€œYedekâ€ menÃ¼sÃ¼nden JSON indirip dÃ¼zenli yedek al.<br/><br/>
              <b>Play Storeâ€™a yÃ¼klemek:</b> Bu dosyayÄ± HTTPS bir adrese (Netlify gibi) koyup Androidâ€™de TWA ile paketleyebiliriz.
            </div>

            <div class="hr"></div>

            <details>
              <summary>ğŸ”’ Veri gizliliÄŸi <span class="badge">Offline</span></summary>
              <div class="body">
                KayÄ±tlar yerel depolamada tutulur. Sunucuya otomatik gÃ¶nderim yoktur. Yedekleri gÃ¼venli sakla.
              </div>
            </details>

            <div class="hr"></div>
            <div class="hint">
              <b>UyarÄ±:</b> Bu uygulama bir â€œsaha kayÄ±t/organizasyonâ€ yardÄ±mcÄ±sÄ±dÄ±r. Resmi dokÃ¼man ve mevzuat yÃ¼kÃ¼mlÃ¼lÃ¼klerini ayrÄ±ca yÃ¼rÃ¼tmek gerekir.
            </div>
          </div>
        </section>
      </main>
    </div>

    <div id="toast" class="toast"></div>

    <!-- Mobile bottom nav -->
    <div class="bottom" aria-label="Alt menÃ¼">
      <button class="btab active" data-tab="dashboard"><span>ğŸ“Š</span>Ã–zet</button>
      <button class="btab" data-tab="newFinding"><span>ğŸ“</span>Bulgu</button>
      <button class="btab" data-tab="checklists"><span>âœ…</span>Liste</button>
      <button class="btab" data-tab="tools"><span>ğŸ§°</span>AraÃ§</button>
      <button class="btab" data-tab="actions"><span>ğŸ“Œ</span>Takip</button>
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const app = $("app");

  // ===== Storage =====
  const KEY = "isg_saha_asistani_pro_v2";
  const DEFAULT_THRESH = { lowMax: 5, midMax: 12 };
  const CATS = ["Genel","Ä°nÅŸaat","Elektrik","YÃ¼ksekte Ã‡alÄ±ÅŸma","Ä°skele / Platform","KaldÄ±rma / VinÃ§","Elle TaÅŸÄ±ma","Kimyasal","YangÄ±n","Makine","Depo / Ä°stif","Ofis","KapalÄ± Alan","LOTO / Enerji Ä°zolasyonu"];

  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return {meta:{expert:{}}, thresholds:{...DEFAULT_THRESH}, findings:[], nearMisses:[], trainings:[], equipmentChecks:[], notes:[], checklist:{}, brand:{}, userTemplates:[]};
      const parsed = JSON.parse(raw);
      if(!parsed || typeof parsed!=="object") throw new Error("bad");
      if(!parsed.meta) parsed.meta = {};
      if(!parsed.meta.expert) parsed.meta.expert = {};
      if(!parsed.brand) parsed.brand = {};
      if(!parsed.thresholds) parsed.thresholds = {...DEFAULT_THRESH};
      if(!Array.isArray(parsed.findings)) parsed.findings = [];
      if(!Array.isArray(parsed.nearMisses)) parsed.nearMisses = [];
      if(!Array.isArray(parsed.trainings)) parsed.trainings = [];
      if(!Array.isArray(parsed.equipmentChecks)) parsed.equipmentChecks = [];
      if(!Array.isArray(parsed.notes)) parsed.notes = [];
      if(!parsed.checklist) parsed.checklist = {};
      if(!Array.isArray(parsed.userTemplates)) parsed.userTemplates = [];
      return parsed;
    }catch(e){
      return {meta:{expert:{}}, thresholds:{...DEFAULT_THRESH}, findings:[], nearMisses:[], trainings:[], equipmentChecks:[], notes:[], checklist:{}, brand:{}, userTemplates:[]};
    }
  }
  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

  let state = load();

  // ===== Helpers =====
  function todayISO(){
    const d = new Date();
    const tz = d.getTimezoneOffset() * 60000;
    return (new Date(d - tz)).toISOString().slice(0,10);
  }
  function uid(){ return "F" + Math.random().toString(16).slice(2) + Date.now().toString(16); }
  function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
  function riskLevel(score){
    const lowMax = clamp(Number(state.thresholds.lowMax||DEFAULT_THRESH.lowMax),1,25);
    const midMax = clamp(Number(state.thresholds.midMax||DEFAULT_THRESH.midMax),1,25);
    if(score <= lowMax) return "low";
    if(score <= midMax) return "mid";
    return "high";
  }
  function riskText(level){ return level==="high"?"YÃ¼ksek":(level==="mid"?"Orta":"DÃ¼ÅŸÃ¼k"); }
  function isOverdue(due, status){
    if(status==="done") return false;
    if(!due) return false;
    return due < todayISO();
  }
  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }
  function shorten(s, n){
    s = String(s ?? "");
    if(s.length <= n) return s;
    return s.slice(0,n-1) + "â€¦";
  }
  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(toast._tm);
    toast._tm = setTimeout(()=>t.style.display="none", 2200);
  }
  function addDays(iso, n){
    const d = new Date(iso+"T00:00:00");
    d.setDate(d.getDate()+n);
    return d.toISOString().slice(0,10);
  }

  // ===== Theme =====
  function setTheme(t){
    app.dataset.theme = t;
    state.meta.theme = t;
    save();
  }
  $("toggleTheme").addEventListener("click", ()=>{
    setTheme(app.dataset.theme === "dark" ? "light" : "dark");
  });

  // ===== Tabs =====
  const sections = ["dashboard","newFinding","checklists","tools","actions","notes","nearMiss","trainings","equipment","exportImport","settings","help"].map(id=>$(id));
  const sideBtns = Array.from(document.querySelectorAll(".navbtn"));
  const bottomBtns = Array.from(document.querySelectorAll(".btab"));

  function setActive(tab){
    sideBtns.forEach(b=>b.classList.toggle("active", b.dataset.tab===tab));
    bottomBtns.forEach(b=>b.classList.toggle("active", b.dataset.tab===tab));
    sections.forEach(s=>s.classList.toggle("hidden", s.id!==tab));

    if(tab==="dashboard") renderDashboard();
    if(tab==="newFinding") renderRecent();
    if(tab==="checklists") renderChecklists();
    if(tab==="tools") renderTools();
    if(tab==="actions") renderActions();
    if(tab==="notes") renderNotes();
    if(tab==="exportImport") renderExportPreview();
    if(tab==="settings") renderSettings();
  }
  sideBtns.forEach(b=>b.addEventListener("click", ()=>setActive(b.dataset.tab)));
  bottomBtns.forEach(b=>b.addEventListener("click", ()=>setActive(b.dataset.tab)));

  // Quick buttons
  $("quickNew").addEventListener("click", ()=>setActive("newFinding"));
  $("quickPrint").addEventListener("click", ()=>printReport());

  // ===== Populate selects =====
  function fillCat(){
    const sel = $("cat");
    sel.innerHTML = "";
    CATS.forEach(c=>{
      const o = document.createElement("option");
      o.value=c; o.textContent=c;
      sel.appendChild(o);
    });
  }
  function fillPS(id){
    const sel = $(id);
    sel.innerHTML = "";
    const items = [
      ["1","1 - Ã‡ok dÃ¼ÅŸÃ¼k"],["2","2 - DÃ¼ÅŸÃ¼k"],["3","3 - Orta"],["4","4 - YÃ¼ksek"],["5","5 - Ã‡ok yÃ¼ksek"]
    ];
    items.forEach(([v,t],i)=>{
      const o = document.createElement("option");
      o.value=v; o.textContent=t;
      if(v==="3") o.selected = true;
      sel.appendChild(o);
    });
  }
  fillCat();
  ["p","s","qp","qs","tP","tS"].forEach(fillPS);

  // ===== Meta inputs =====
  function syncMeta(){
    $("siteName").value = state.meta.siteName || "";
    $("siteDept").value = state.meta.siteDept || "";
    $("auditor").value  = state.meta.auditor  || "";
    $("siteDate").value = state.meta.siteDate || todayISO();
  }
  function pullMeta(){
    state.meta.siteName = $("siteName").value.trim();
    state.meta.siteDept = $("siteDept").value.trim();
    state.meta.auditor  = $("auditor").value.trim();
    state.meta.siteDate = $("siteDate").value || todayISO();
    save();
  }
  ["siteName","siteDept","auditor","siteDate"].forEach(id=>$(id).addEventListener("change", pullMeta));

  // ===== Expert (Ä°SG UzmanÄ±) =====
  function getExpert(){
    const ex = (state.meta && state.meta.expert) ? state.meta.expert : {};
    return {
      name: (ex.name || "Fatih AKDENÄ°Z").trim(),
      cls:  (ex.cls  || "B").trim().toUpperCase(),
      cert: (ex.cert || "").trim(),
      org:  (ex.org  || "").trim(),
      contact: (ex.contact || "").trim()
    };
  }
  function applyExpertToHeader(){
    const ex = getExpert();
    const mark = $("expertMark");
    const nm   = $("expertName");
    const cl   = $("expertClass");
    const extra= $("expertExtra");
    if(mark) mark.textContent = ex.cls || "B";
    if(nm) nm.textContent = ex.name || "Ä°SG UZMANI";
    if(cl) cl.textContent = `(${ex.cls || "B"})`;

    const parts = [];
    if(ex.cert) parts.push(`Belge No: ${ex.cert}`);
    if(ex.org) parts.push(ex.org);
    if(ex.contact) parts.push(ex.contact);
    extra.textContent = parts.join(" â€¢ ");
  }

  // ===== Thresholds UI (Tools) =====
  function updateQuickRisk(){
    const p = Number($("qp").value);
    const s = Number($("qs").value);
    const score = p*s;
    const lvl = riskLevel(score);
    const el = $("qRisk");
    el.className = "tag " + (lvl==="high"?"risk-high":(lvl==="mid"?"risk-mid":"risk-low"));
    el.textContent = `Risk: ${score} (${riskText(lvl)})`;
  }
  $("qp").addEventListener("change", updateQuickRisk);
  $("qs").addEventListener("change", updateQuickRisk);

  function updateRiskTag(){
    const p = Number($("p").value);
    const s = Number($("s").value);
    const score = p*s;
    const lvl = riskLevel(score);
    const tag = $("riskTag");
    tag.className = "tag " + (lvl==="high"?"risk-high":(lvl==="mid"?"risk-mid":"risk-low"));
    tag.textContent = `Risk: ${score} (${riskText(lvl)})`;
  }
  $("p").addEventListener("change", updateRiskTag);
  $("s").addEventListener("change", updateRiskTag);

  // ===== Templates =====
  const defaultTemplates = [
    {id:"t1", title:"AÃ§Ä±k elektrik panosu", cat:"Elektrik", loc:"", desc:"Elektrik panosu kapaÄŸÄ± aÃ§Ä±k / kilitsiz. Yetkisiz eriÅŸim riski.",
      control:"Pano kapaÄŸÄ± kapatÄ±lmalÄ±, kilitlenmeli. UyarÄ± levhasÄ± ve yetkilendirme saÄŸlanmalÄ±. Periyodik pano kontrolÃ¼ yapÄ±lmalÄ±.", p:3,s:4},
    {id:"t2", title:"KKD uygunsuzluÄŸu (baret / gÃ¶zlÃ¼k)", cat:"Genel", loc:"", desc:"Ã‡alÄ±ÅŸanlarda baret/gÃ¶zlÃ¼k kullanÄ±mÄ± yetersiz. GÃ¶z yaralanmasÄ± / baÅŸ travmasÄ± riski.",
      control:"Saha sorumlusu tarafÄ±ndan anlÄ±k uyarÄ±, KKD kontrolÃ¼ ve disiplin sÃ¼reci. KKD zimmet ve eÄŸitim kayÄ±tlarÄ±nÄ±n gÃ¼ncellenmesi.", p:3,s:3},
    {id:"t3", title:"YÃ¼ksekte Ã§alÄ±ÅŸma korkuluk yok", cat:"YÃ¼ksekte Ã‡alÄ±ÅŸma", loc:"", desc:"AÃ§Ä±k kenar/boÅŸlukta korkuluk yok. DÃ¼ÅŸme riski.",
      control:"Toplu koruma Ã¶ncelikli: korkuluk + ara korkuluk + eteklik. Uygunsa gÃ¼venlik aÄŸÄ±. KKD yalnÄ±z baÅŸÄ±na yeterli deÄŸil.", p:4,s:5},
    {id:"t4", title:"Ä°skele etiketleme yok", cat:"Ä°skele / Platform", loc:"", desc:"Ä°skelede yeÅŸil/kÄ±rmÄ±zÄ± etiketleme ve kontrol kaydÄ± yok. KullanÄ±m gÃ¼venliÄŸi belirsiz.",
      control:"Yetkili kiÅŸi kontrolÃ¼ sonrasÄ± etiketleme yapÄ±lmalÄ±. GÃ¼nlÃ¼k gÃ¶rsel kontrol + periyodik kayÄ±t oluÅŸturulmalÄ±.", p:3,s:4},
    {id:"t5", title:"YangÄ±n tÃ¼pÃ¼ eriÅŸimi kapalÄ±", cat:"YangÄ±n", loc:"", desc:"YangÄ±n tÃ¼pÃ¼nÃ¼n Ã¶nÃ¼ kapalÄ± / eriÅŸim zor. Acilde mÃ¼dahale gecikebilir.",
      control:"EriÅŸim alanÄ± boÅŸaltÄ±lmalÄ± (min 1 m). YÃ¶nlendirme levhasÄ±. AylÄ±k kontrol ve dolum tarihleri takip edilmeli.", p:3,s:3},
    {id:"t6", title:"KaldÄ±rma: sapan yÄ±pranmÄ±ÅŸ", cat:"KaldÄ±rma / VinÃ§", loc:"", desc:"Sapan/halat Ã¼zerinde yÄ±pranma var. Kopma riski.",
      control:"KullanÄ±mdan kaldÄ±r, uygun sapan ile deÄŸiÅŸtir. Aksesuar periyodik kontrol kayÄ±tlarÄ±nÄ± gÃ¼ncelle.", p:3,s:5},
    {id:"t7", title:"LOTO yok / enerji izolasyonu belirsiz", cat:"LOTO / Enerji Ä°zolasyonu", loc:"", desc:"BakÄ±m/temizlik sÄ±rasÄ±nda enerji izolasyonu (LOTO) uygulanmÄ±yor. Beklenmedik Ã§alÄ±ÅŸtÄ±rma riski.",
      control:"Enerji kaynaklarÄ±nÄ± belirle, kilitle/etiketle (LOTO). Yetkilendirme ve doÄŸrulama adÄ±mlarÄ±nÄ± kayÄ±t altÄ±na al.", p:4,s:5},
{id:"t8", title:"KapalÄ± alan giriÅŸ izni yok", cat:"KapalÄ± Alan", loc:"", desc:"KapalÄ± alana giriÅŸ izin formu/Ã¶lÃ§Ã¼m/izleme ÅŸartlarÄ± saÄŸlanmadan giriÅŸ planlanÄ±yor. BoÄŸulma/zehirlenme riski.",
  control:"KapalÄ± alan prosedÃ¼rÃ¼ uygulanmalÄ±: gaz Ã¶lÃ§Ã¼mÃ¼, havalandÄ±rma, gÃ¶zcÃ¼, kurtarma planÄ±, izin formu ve yetkilendirme.", p:4,s:5},
{id:"t9", title:"Makine koruyucu kapaÄŸÄ± sÃ¶kÃ¼lmÃ¼ÅŸ", cat:"Makine", loc:"", desc:"Makine Ã¼zerinde koruyucu muhafaza/kapak sÃ¶kÃ¼lmÃ¼ÅŸ veya devre dÄ±ÅŸÄ±. SÄ±kÄ±ÅŸma/ezilme riski.",
  control:"Koruyucular takÄ±lmalÄ±, emniyet switchleri devre dÄ±ÅŸÄ± bÄ±rakÄ±lmamalÄ±. BakÄ±m Ã¶ncesi LOTO uygulanmalÄ±.", p:4,s:4},
{id:"t10", title:"Forklift hÄ±z / yaya ayrÄ±mÄ± yetersiz", cat:"Depo / Ä°stif", loc:"", desc:"Forklift gÃ¼zergahÄ± ile yaya yolu net ayrÄ±lmamÄ±ÅŸ. Ã‡arpma/ezilme riski.",
  control:"Yaya-forklift yollarÄ± Ã§izgi/bariyer ile ayrÄ±lmalÄ±. HÄ±z limitleri ve ayna/ikazlar konumlandÄ±rÄ±lmalÄ±.", p:3,s:5},
{id:"t11", title:"Kimyasal etiket/MSDS eksik", cat:"Kimyasal", loc:"", desc:"Kimyasal kaplarda etiket yok veya MSDS eriÅŸimi yok. Maruziyet ve yanlÄ±ÅŸ kullanÄ±m riski.",
  control:"Etiketleme tamamlanmalÄ±. MSDS eriÅŸimi saÄŸlanmalÄ±. Uygun depolama ve KKD seÃ§imi yapÄ±lmalÄ±.", p:3,s:4},
{id:"t12", title:"SÄ±cak iÅŸ izni uygulanmÄ±yor", cat:"YangÄ±n", loc:"", desc:"Kaynak/taÅŸlama gibi sÄ±cak iÅŸlerde izin formu ve yangÄ±n Ã¶nlemleri uygulanmÄ±yor. YangÄ±n riski.",
  control:"SÄ±cak iÅŸ izin prosedÃ¼rÃ¼, yangÄ±n gÃ¶zcÃ¼sÃ¼, kÄ±vÄ±lcÄ±m perdesi, Ã§evre temizliÄŸi, uygun sÃ¶ndÃ¼rÃ¼cÃ¼ hazÄ±r bulundurulmalÄ±.", p:4,s:5},
{id:"t13", title:"Merdiven uygunsuz kullanÄ±lÄ±yor", cat:"Genel", loc:"", desc:"Merdiven sabitleme/aÃ§Ä± uygun deÄŸil veya Ã¼st basamakta Ã§alÄ±ÅŸma yapÄ±lÄ±yor. DÃ¼ÅŸme riski.",
  control:"Merdiven uygun aÃ§Ä±yla kurulmalÄ±, sabitlenmeli. Uygun platform/iskeleden Ã§alÄ±ÅŸma planlanmalÄ±.", p:3,s:4},
{id:"t14", title:"Kablo geÃ§iÅŸi korumasÄ±z", cat:"Elektrik", loc:"", desc:"Yaya/araÃ§ geÃ§iÅŸinde kablolar korumasÄ±z. Ezilme ve elektrik riski.",
  control:"Kablo kÃ¶prÃ¼sÃ¼/koruma kullanÄ±lmalÄ±, kablo gÃ¼zergahÄ± dÃ¼zenlenmeli. HasarlÄ± kablo derhal deÄŸiÅŸtirilmeli.", p:3,s:4},
{id:"t15", title:"Acil Ã§Ä±kÄ±ÅŸ Ã¶nÃ¼ kapalÄ±", cat:"YangÄ±n", loc:"", desc:"Acil Ã§Ä±kÄ±ÅŸ kapÄ±sÄ± Ã¶nÃ¼ malzeme ile kapalÄ± veya kilitli. Tahliye gecikmesi riski.",
  control:"Acil Ã§Ä±kÄ±ÅŸ Ã¶nÃ¼ sÃ¼rekli aÃ§Ä±k tutulmalÄ±. Kilit/engeller kaldÄ±rÄ±lmalÄ±. Uygun yÃ¶nlendirme ve denetim yapÄ±lmalÄ±.", p:3,s:5},
{id:"t16", title:"GÃ¼rÃ¼ltÃ¼ maruziyeti kontrolsÃ¼z", cat:"Genel", loc:"", desc:"YÃ¼ksek gÃ¼rÃ¼ltÃ¼lÃ¼ alanda Ã¶lÃ§Ã¼m/iÅŸaretleme ve kulaklÄ±k kullanÄ±mÄ± yetersiz. Ä°ÅŸitme kaybÄ± riski.",
  control:"GÃ¼rÃ¼ltÃ¼ Ã¶lÃ§Ã¼mÃ¼ ve risk deÄŸerlendirmesi yapÄ±lmalÄ±. MÃ¼hendislik Ã¶nlemleri + uygun kulak koruyucu temini ve kullanÄ±mÄ±.", p:3,s:4},
{id:"t17", title:"Toz kontrolÃ¼ yetersiz", cat:"Genel", loc:"", desc:"Kesme/taÅŸlama/temizlik faaliyetlerinde toz bastÄ±rma ve uygun maske kullanÄ±mÄ± yetersiz. Solunum riski.",
  control:"Islak kesim/toz emiÅŸi uygulanmalÄ±. Uygun maske (P2/P3) ve eÄŸitim. Alan temizliÄŸi planlÄ± yapÄ±lmalÄ±.", p:3,s:4},
{id:"t18", title:"DÃ¶kÃ¼lme kiti yok", cat:"Kimyasal", loc:"", desc:"Kimyasal depolama/transfer alanÄ±nda dÃ¶kÃ¼lme kiti ve prosedÃ¼r yok. Kayma/yanma/Ã§evresel risk.",
  control:"DÃ¶kÃ¼lme kiti temin edilmeli. DÃ¶kÃ¼lme mÃ¼dahale talimatÄ± gÃ¶rÃ¼nÃ¼r olmalÄ±. EÄŸitim yapÄ±lmalÄ±.", p:3,s:4},
{id:"t19", title:"KaldÄ±rma planÄ± yok", cat:"KaldÄ±rma / VinÃ§", loc:"", desc:"Kritik kaldÄ±rma iÃ§in plan/izin ve gÃ¶rev daÄŸÄ±lÄ±mÄ± yapÄ±lmamÄ±ÅŸ. Devrilme/Ã§arpma riski.",
  control:"KaldÄ±rma planÄ±, yÃ¼k hesaplarÄ±, alan izolasyonu, gÃ¶revli iÅŸaretÃ§i ve iletiÅŸim planÄ± hazÄ±rlanmalÄ±.", p:4,s:5},
{id:"t20", title:"Kesici-delici atÄ±klarÄ± uygunsuz", cat:"Genel", loc:"", desc:"Kesici-delici atÄ±klar uygun kutuda toplanmÄ±yor. Yaralanma ve enfeksiyon riski.",
  control:"Kesici-delici kutularÄ± saÄŸlanmalÄ±, doluluk takip edilmeli. Uygun atÄ±k prosedÃ¼rÃ¼ ve eÄŸitim yapÄ±lmalÄ±.", p:3,s:3},

  ];
  function allTemplates(){
    return [...defaultTemplates, ...(state.userTemplates||[])];
  }
  function applyTemplate(t){
    $("cat").value = t.cat;
    $("loc").value = t.loc || "";
    $("desc").value = t.desc || "";
    $("control").value = t.control || "";
    $("p").value = String(t.p||3);
    $("s").value = String(t.s||3);
    updateRiskTag();
  }
  $("prefillFromTemplate").addEventListener("click", ()=>{
    applyTemplate(allTemplates()[0]);
    toast("Åablon dolduruldu");
  });

  function renderTemplates(){
    const box = $("tplList");
    box.innerHTML = "";
    allTemplates().forEach((t,i)=>{
      const div = document.createElement("div");
      div.className = "k";
      const score = (t.p||3)*(t.s||3);
      const lvl = riskLevel(score);
      div.innerHTML = `
        <div style="display:flex;gap:10px;align-items:center;justify-content:space-between">
          <div>
            <div style="font-weight:1000">${escapeHtml(t.title)}</div>
            <div class="hint" style="margin-top:4px">${escapeHtml(t.cat)} â€¢ Risk Ã¶nerisi: <b>${score}</b> (${riskText(lvl)})</div>
          </div>
          <button class="btn primary" data-i="${i}">Doldur</button>
        </div>`;
      div.querySelector("button").addEventListener("click", ()=>{
        applyTemplate(allTemplates()[i]);
        setActive("newFinding");
        toast("Åablon dolduruldu");
      });
      box.appendChild(div);
      box.appendChild(document.createElement("div")).className="hr";
    });
    const hrs = box.querySelectorAll(".hr");
    if(hrs.length) hrs[hrs.length-1].remove();
  }

  // ===== Photo handling (single image as data URL) =====
  let pendingPhotoData = "";
  $("photo").addEventListener("change", async (e)=>{
    pendingPhotoData = "";
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    if(file.size > 2_200_000){ // ~2.2MB
      toast("FotoÄŸraf bÃ¼yÃ¼k (2MB+). KÃ¼Ã§Ã¼k seÃ§men daha iyi.");
    }
    pendingPhotoData = await readAsDataURL(file, 1100);
    toast("FotoÄŸraf eklendi");
  });
  function readAsDataURL(file, maxWidth){
    return new Promise((resolve, reject)=>{
      const img = new Image();
      const reader = new FileReader();
      reader.onload = ()=>{ img.src = reader.result; };
      reader.onerror = ()=>reject(reader.error);
      img.onload = ()=>{
        // downscale
        const w = img.width, h = img.height;
        const ratio = Math.min(1, maxWidth / Math.max(1,w));
        const cw = Math.round(w*ratio), ch = Math.round(h*ratio);
        const canvas = document.createElement("canvas");
        canvas.width = cw; canvas.height = ch;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, cw, ch);
        resolve(canvas.toDataURL("image/jpeg", 0.80));
      };
      img.onerror = ()=>resolve(reader.result); // fallback
      reader.readAsDataURL(file);
    });
  }

  // ===== Save finding =====
  function clearFindingForm(){
    $("cat").value = "Genel";
    $("loc").value = "";
    $("desc").value = "";
    $("control").value = "";
    $("p").value = "3";
    $("s").value = "3";
    $("owner").value = "";
    $("due").value = "";
    $("photo").value = "";
    pendingPhotoData = "";
    updateRiskTag();
  }
  $("clearFinding").addEventListener("click", ()=>{
    clearFindingForm();
    toast("Form temizlendi");
  });

  $("saveFinding").addEventListener("click", ()=>{
    pullMeta();
    const cat = $("cat").value;
    const loc = $("loc").value.trim();
    const desc = $("desc").value.trim();
    const control = $("control").value.trim();
    const p = Number($("p").value);
    const s = Number($("s").value);
    const owner = $("owner").value.trim();
    const due = $("due").value || "";

    if(!desc){ toast("Bulgu tanÄ±mÄ± boÅŸ olamaz"); return; }

    const score = p*s;
    const lvl = riskLevel(score);
    // Termin boÅŸsa risk seviyesine gÃ¶re Ã¶neri (dÃ¼zenlenebilir)
    let dueSmart = due;
    if(!dueSmart){
      const t = todayISO();
      if(lvl==='high') dueSmart = t;
      else if(lvl==='mid') dueSmart = addDays(t, 7);
      else dueSmart = addDays(t, 30);
    }
    const now = new Date().toISOString();

    state.findings.unshift({
      id: uid(),
      createdAt: now,
      updatedAt: now,
      meta: {...state.meta},
      cat, loc, desc, control,
      p, s, score, level: lvl,
      owner, due: dueSmart,
      status: "open",
      photo: pendingPhotoData || ""
    });
    save();
    renderRecent();
    renderDashboard();
    toast("Kaydedildi");
    // keep category/risk; clear text/loc/photo
    $("loc").value="";
    $("desc").value="";
    $("control").value="";
    $("photo").value="";
    pendingPhotoData = "";
  });

  // ===== Recent list =====
  function cardFinding(f){
    const overdue = isOverdue(f.due, f.status);
    const dueTxt = f.due ? `${f.due}${overdue ? " (gecikmiÅŸ)" : ""}` : "-";
    const cls = f.level==="high" ? "risk-high" : (f.level==="mid" ? "risk-mid" : "risk-low");
    const hasPhoto = !!f.photo;
    return `
      <div class="k">
        <div style="display:flex;gap:10px;align-items:flex-start;justify-content:space-between">
          <div>
            <div class="row" style="gap:8px">
              <span class="tag ${cls}">Risk ${f.score} â€¢ ${riskText(f.level)}</span>
              <span class="badge">${escapeHtml(f.cat)}</span>
              ${hasPhoto ? '<span class="badge">ğŸ“· foto</span>' : ''}
            </div>
            <div style="font-weight:1000;margin-top:8px">${escapeHtml(shorten(f.desc,110))}</div>
            <div class="hint" style="margin-top:6px">
              ğŸ“ ${escapeHtml(f.loc||"-")} â€¢ ğŸ‘¤ ${escapeHtml(f.owner||"-")} â€¢ â³ ${escapeHtml(dueTxt)}
            </div>
            ${f.control ? `<div class="hint" style="margin-top:10px"><b>Ã–nlem:</b> ${escapeHtml(shorten(f.control,170))}</div>` : ``}
            ${hasPhoto ? `<div style="margin-top:10px"><img alt="bulgu foto" src="${f.photo}" style="max-width:100%;border-radius:16px;border:1px solid var(--line)"></div>` : ``}
          </div>
          <div class="row">
            <button class="btn" data-act="toggle" data-id="${f.id}">${f.status==="done"?"AÃ§":"Kapat"}</button>
            <button class="btn danger" data-act="del" data-id="${f.id}">Sil</button>
          </div>
        </div>
      </div>`;
  }

  function renderRecent(){
    const box = $("recent");
    const list = state.findings.slice(0,5);
    if(list.length===0){ box.className="hint"; box.textContent="HenÃ¼z kayÄ±t yok."; return; }
    box.className="";
    box.innerHTML = list.map(cardFinding).join('<div class="hr"></div>');
    box.querySelectorAll("button").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.dataset.id;
        const act = b.dataset.act;
        if(act==="del"){
          if(!confirm("Bu kaydÄ± silmek istiyor musun?")) return;
          state.findings = state.findings.filter(x=>x.id!==id);
          save();
          renderRecent(); renderDashboard(); renderActions();
          toast("Silindi");
        }else if(act==="toggle"){
          const f = state.findings.find(x=>x.id===id);
          if(!f) return;
          f.status = (f.status==="done" ? "open" : "done");
          f.updatedAt = new Date().toISOString();
          save();
          renderRecent(); renderDashboard(); renderActions();
          toast(f.status==="done" ? "KapandÄ±" : "AÃ§Ä±ldÄ±");
        }
      });
    });
  }

  // ===== Dashboard =====
  function setBar(el, n, max){
    const pct = max<=0 ? 0 : (n/max);
    const h = 20 + Math.round(pct * 64);
    el.style.height = `${h}px`;
  }
  function renderDashboard(){
    pullMeta();

    const total = state.findings.length;
    const open = state.findings.filter(f=>f.status!=="done").length;
    const overdue = state.findings.filter(f=>isOverdue(f.due,f.status)).length;
    const highOpen = state.findings.filter(f=>f.level==="high" && f.status!=="done").length;

    $("kTotal").textContent = total;
    $("kOpen").textContent = open;
    $("kOverdue").textContent = overdue;
    $("kHigh").textContent = highOpen;

    const low = state.findings.filter(f=>f.level==="low").length;
    const mid = state.findings.filter(f=>f.level==="mid").length;
    const high = state.findings.filter(f=>f.level==="high").length;
    $("nLow").textContent = `${low}`;
    $("nMid").textContent = `${mid}`;
    $("nHigh").textContent = `${high}`;
    const max = Math.max(low, mid, high, 1);
    setBar($("barLow"), low, max);
    setBar($("barMid"), mid, max);
    setBar($("barHigh"), high, max);

    // list open actions
    const filter = $("dashFilter").value;
    const sort = $("dashSort").value;

    let items = state.findings.filter(f=>f.status!=="done");

    if(filter==="overdue") items = items.filter(f=>isOverdue(f.due,f.status));
    if(filter==="next7"){
      const t = todayISO();
      const d7 = addDays(t,7);
      items = items.filter(f=>f.due && f.due>=t && f.due<=d7);
    }
    if(filter==="high") items = items.filter(f=>f.level==="high");

    if(sort==="dueAsc"){
      items.sort((a,b)=> (a.due||"9999-12-31").localeCompare(b.due||"9999-12-31"));
    }else if(sort==="riskDesc"){
      items.sort((a,b)=> (b.score - a.score));
    }else{
      items.sort((a,b)=> (b.createdAt||"").localeCompare(a.createdAt||""));
    }

    const list = items.slice(0,7);
    const box = $("dashList");
    if(list.length===0){
      box.className="hint";
      box.textContent="Bu filtrede gÃ¶sterilecek aÃ§Ä±k aksiyon yok.";
      return;
    }

    box.className="";
    box.innerHTML = list.map(f=>{
      const overdue = isOverdue(f.due,f.status);
      const cls = f.level==="high" ? "risk-high" : (f.level==="mid" ? "risk-mid" : "risk-low");
      return `
        <div class="k">
          <div style="display:flex;gap:10px;align-items:flex-start;justify-content:space-between">
            <div>
              <div class="row" style="gap:8px">
                <span class="tag ${cls}">Risk ${f.score} â€¢ ${riskText(f.level)}</span>
                <span class="badge">${escapeHtml(f.cat)}</span>
                ${f.photo ? '<span class="badge">ğŸ“·</span>' : ''}
              </div>
              <div style="font-weight:1000;margin-top:8px">${escapeHtml(shorten(f.desc,120))}</div>
              <div class="hint" style="margin-top:6px">
                ğŸ“ ${escapeHtml(f.loc||"-")} â€¢ ğŸ‘¤ ${escapeHtml(f.owner||"-")} â€¢ â³ ${f.due ? `${escapeHtml(f.due)}${overdue?" (gecikmiÅŸ)":""}`:"-"}
              </div>
            </div>
            <div class="row">
              <button class="btn" data-id="${f.id}">Kapat</button>
            </div>
          </div>
        </div>`;
    }).join('<div class="hr"></div>');

    box.querySelectorAll("button").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.dataset.id;
        const f = state.findings.find(x=>x.id===id);
        if(!f) return;
        f.status = "done";
        f.updatedAt = new Date().toISOString();
        save();
        renderDashboard(); renderActions(); renderRecent();
        toast("Aksiyon kapandÄ±");
      });
    });
  }

  $("dashFilter").addEventListener("change", renderDashboard);
  $("dashSort").addEventListener("change", renderDashboard);

  // ===== Actions table =====
  function debounce(fn, ms){
    let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
  }
  function renderActions(){
    const status = $("fStatus").value;
    const risk = $("fRisk").value;
    const q = $("fSearch").value.trim().toLowerCase();
    const sort = $("fSort").value;

    let items = state.findings.slice();

    if(status==="open") items = items.filter(f=>f.status!=="done");
    if(status==="done") items = items.filter(f=>f.status==="done");

    if(risk!=="all") items = items.filter(f=>f.level===risk);

    if(q){
      items = items.filter(f=>{
        const hay = `${f.cat} ${f.loc} ${f.desc} ${f.owner} ${f.control}`.toLowerCase();
        return hay.includes(q);
      });
    }

    if(sort==="riskDesc") items.sort((a,b)=>b.score-a.score);
    if(sort==="dueAsc") items.sort((a,b)=>(a.due||"9999-12-31").localeCompare(b.due||"9999-12-31"));
    if(sort==="newDesc") items.sort((a,b)=>(b.createdAt||"").localeCompare(a.createdAt||""));

    const tbody = $("actionRows");
    tbody.innerHTML = "";
    if(items.length===0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="7" style="background:transparent;border:none;color:var(--muted);padding:18px 6px">KayÄ±t bulunamadÄ±.</td>`;
      tbody.appendChild(tr);
      return;
    }

    items.forEach(f=>{
      const overdue = isOverdue(f.due,f.status);
      const cls = f.level==="high" ? "risk-high" : (f.level==="mid" ? "risk-mid" : "risk-low");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><span class="tag ${cls}">${f.score} â€¢ ${riskText(f.level)}</span></td>
        <td>${escapeHtml(f.cat)}</td>
        <td>
          <div style="font-weight:1000">${escapeHtml(f.loc||"-")}</div>
          <div class="hint">${escapeHtml(shorten(f.desc,120))}</div>
        </td>
        <td>${escapeHtml(f.owner||"-")}</td>
        <td>${f.due ? `${escapeHtml(f.due)}${overdue ? ' <span class="badge" style="border-color:rgba(255,107,107,.55);color:var(--bad)">gecikmiÅŸ</span>' : ''}` : '-'}</td>
        <td>${f.status==="done" ? '<span class="badge" style="border-color:rgba(49,208,127,.45);color:var(--accent2)">kapalÄ±</span>' : '<span class="badge" style="border-color:rgba(255,204,102,.45);color:var(--warn)">aÃ§Ä±k</span>'}</td>
        <td class="nowrap">
          <button class="btn" data-act="toggle" data-id="${f.id}">${f.status==="done" ? "AÃ§" : "Kapat"}</button>
          <button class="btn danger" data-act="del" data-id="${f.id}">Sil</button>
        </td>`;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("button").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.dataset.id;
        const act = btn.dataset.act;
        if(act==="del"){
          if(!confirm("Bu kaydÄ± silmek istiyor musun?")) return;
          state.findings = state.findings.filter(x=>x.id!==id);
          save();
          renderActions(); renderDashboard(); renderRecent();
          toast("Silindi");
        }else{
          const f = state.findings.find(x=>x.id===id);
          if(!f) return;
          f.status = (f.status==="done" ? "open" : "done");
          f.updatedAt = new Date().toISOString();
          save();
          renderActions(); renderDashboard(); renderRecent();
          toast(f.status==="done" ? "KapandÄ±" : "AÃ§Ä±ldÄ±");
        }
      });
    });
  }
  ["fStatus","fRisk","fSort"].forEach(id=>$(id).addEventListener("change", renderActions));
  $("fSearch").addEventListener("input", debounce(renderActions, 200));

  // ===== Checklists =====
  const checklists = [
    { id:"insaat", name:"Ä°nÅŸaat - Genel Saha KontrolÃ¼", items:[
      {q:"YÃ¼ksekte Ã§alÄ±ÅŸma alanlarÄ±nda toplu koruma var mÄ±? (korkuluk/kapak/aÄŸ)", note:"AÃ§Ä±k kenar, boÅŸluk, merdiven kovasÄ± vb."},
      {q:"Ä°skeleler kontrol edilmiÅŸ ve etiketlenmiÅŸ mi?", note:"Kurulum sonrasÄ± yetkili kontrol + etiket + kayÄ±t"},
      {q:"GeÃ§ici elektrik tesisatÄ± gÃ¼venli mi? (RCD/kaÃ§ak akÄ±m, pano, kablo)", note:"Kablo ezilmesi/sarkmasÄ±, topraklama, pano kilidi"},
      {q:"YÃ¼rÃ¼yÃ¼ÅŸ yollarÄ± dÃ¼zenli mi? (takÄ±lma/kayma riski)", note:"DaÄŸÄ±nÄ±k malzeme, moloz, kablo, Ä±slak zemin"},
      {q:"KaldÄ±rma operasyonunda alan izolasyonu var mÄ±?", note:"YÃ¼k altÄ± yasak, iÅŸaretÃ§i, iÅŸaretleme/bariyer"},
      {q:"YangÄ±n sÃ¶ndÃ¼rÃ¼cÃ¼ler eriÅŸilebilir mi?", note:"EriÅŸim 1 m, levha, kontrol tarihi"},
      {q:"KKD kullanÄ±mÄ± iÅŸin riskine uygun mu?", note:"Baret, yelek, gÃ¶zlÃ¼k, eldiven, kemer vb."},
      {q:"Merdivenler uygun ve saÄŸlam mÄ±?", note:"KaydÄ±rmaz ayak, aÃ§Ä±, sabitleme"},
      {q:"SÄ±cak iÅŸ (kaynak/taÅŸlama) iÃ§in Ã¶nlemler var mÄ±?", note:"YangÄ±n gÃ¶zcÃ¼sÃ¼, kÄ±vÄ±lcÄ±m perdesi, izin prosedÃ¼rÃ¼"},
    ]},
    { id:"ofis", name:"Ofis - Ä°SG KontrolÃ¼", items:[
      {q:"Acil Ã§Ä±kÄ±ÅŸlar aÃ§Ä±k ve yÃ¶nlendirmeler gÃ¶rÃ¼nÃ¼r mÃ¼?", note:"KapÄ± Ã¶nÃ¼ boÅŸ, levha/aydÄ±nlatma var"},
      {q:"Elektrik priz/uzatma kablolarÄ±nda aÅŸÄ±rÄ± yÃ¼k var mÄ±?", note:"Ã‡oklu priz zinciri yok, kablo hasarÄ± yok"},
      {q:"Ergonomi uygun mu? (monitÃ¶r hizasÄ±/sandalye/aydÄ±nlatma)", note:"Boyun-bilek-belde zorlanma"},
      {q:"YangÄ±n tÃ¼pÃ¼ ve ilk yardÄ±m malzemeleri eriÅŸilebilir mi?", note:"Kontrol tarihleri gÃ¼ncel mi?"},
      {q:"Zemin dÃ¼zeni uygun mu? (takÄ±lma/kayma)", note:"Kablo yÃ¶netimi, daÄŸÄ±nÄ±klÄ±k"},
    ]},
    { id:"depo", name:"Depo / Ä°stif - Kontrol", items:[
      {q:"Raf sistemleri sabit ve hasarsÄ±z mÄ±?", note:"Deformasyon, ankraj, yÃ¼k etiketi"},
      {q:"Ä°stif gÃ¼venli mi? (yÃ¼kseklik/devrilme)", note:"AÅŸÄ±rÄ± istif yok, baÄŸlama/ÅŸeritleme"},
      {q:"Forklift/yaya yollarÄ± ayrÄ±lmÄ±ÅŸ mÄ±?", note:"Bariyer/Ã§izgi/ayna/ikaz"},
      {q:"Elle taÅŸÄ±ma iÃ§in yardÄ±mcÄ± ekipman var mÄ±?", note:"Transpalet, kaldÄ±rma aparatÄ±"},
      {q:"Kimyasal depolama uygun mu?", note:"Etiket, MSDS, havalandÄ±rma, dÃ¶kÃ¼lme kiti"},
      {q:"Acil durum ekipmanlarÄ± eriÅŸilebilir mi?", note:"GÃ¶z duÅŸu, yangÄ±n tÃ¼pÃ¼, exit"},
    ]},
,
{ id:"elektrik_detay", name:"Elektrik - Detay Kontrol", items:[
  {q:"KaÃ§ak akÄ±m rÃ¶leleri (RCD) uygun ve test edildi mi?", note:"Test butonu / periyodik kontrol"},
  {q:"GeÃ§ici panolar kilitli ve etiketli mi?", note:"Yetkisiz eriÅŸim engeli"},
  {q:"Topraklama ve kablo kesitleri uygun mu?", note:"GÃ¶zle kontrol + yetkili Ã¶lÃ§Ã¼m"},
  {q:"Kablo ekleri uygunsuz mu? (bant/sÃ¶k-tak)", note:"Uygun buat ve koruma ÅŸart"},
  {q:"AÃ§Ä±kta iletken/izolesiz nokta var mÄ±?", note:"Derhal izolasyon/onarÄ±m"},
  {q:"Islak/Ä±slak zeminlerde elektrikli ekipman kontrolÃ¼ yapÄ±ldÄ± mÄ±?", note:"IP koruma ve RCD kritik"},
  {q:"Priz/uzatma kablolarÄ±nda aÅŸÄ±rÄ± yÃ¼k var mÄ±?", note:"Zincirleme Ã§oklu priz yok"},
  {q:"Enerji izolasyonu (LOTO) uygulanÄ±yor mu?", note:"BakÄ±m/temizlik iÅŸleri"},
]},
{ id:"yuksek", name:"YÃ¼ksekte Ã‡alÄ±ÅŸma - Detay Kontrol", items:[
  {q:"AÃ§Ä±k kenar/boÅŸluklarda korkuluk/kapak mevcut mu?", note:"Etek tahtasÄ± + ara korkuluk"},
  {q:"YaÅŸam hattÄ±/ankraj noktalarÄ± uygun mu?", note:"SertifikalÄ± ve yerinde kontrol"},
  {q:"Kemer baÄŸlantÄ±sÄ± doÄŸru yapÄ±lÄ±yor mu?", note:"Åok emici + uygun kanca"},
  {q:"Merdiven/eriÅŸim ekipmanÄ± uygun mu?", note:"AÃ§Ä±, sabitleme, kaydÄ±rmaz ayak"},
  {q:"DÃ¼ÅŸen cisim riski iÃ§in alan izolasyonu var mÄ±?", note:"Bariyer + uyarÄ± levhasÄ±"},
  {q:"Hava ÅŸartlarÄ± (rÃ¼zgar/yaÄŸÄ±ÅŸ) takip ediliyor mu?", note:"Gerekirse iÅŸi durdur"},
  {q:"Ä°skele/platform gÃ¼nlÃ¼k kontrolÃ¼ yapÄ±ldÄ± mÄ±?", note:"Etiket + kayÄ±t"},
]},
{ id:"makine", name:"Makine - Koruyucu / LOTO Kontrol", items:[
  {q:"Makine koruyucularÄ± takÄ±lÄ± ve Ã§alÄ±ÅŸÄ±r mÄ±?", note:"Muhafaza/switch devre dÄ±ÅŸÄ± deÄŸil"},
  {q:"Acil stoplar eriÅŸilebilir ve test edildi mi?", note:"Periyodik test Ã¶nerilir"},
  {q:"BakÄ±m/temizlikte LOTO uygulanÄ±yor mu?", note:"Kilitle-etiketle ve doÄŸrulama"},
  {q:"DÃ¶nen aksam/aktarma organlarÄ± korunmuÅŸ mu?", note:"Kaplin, kayÄ±ÅŸ-kasnak vb."},
  {q:"Yetkisiz kullanÄ±m engellenmiÅŸ mi?", note:"Anahtar kontrolÃ¼/izinsiz Ã§alÄ±ÅŸtÄ±rma"},
]},
{ id:"yangin_detay", name:"YangÄ±n - Detay Kontrol", items:[
  {q:"YangÄ±n sÃ¶ndÃ¼rÃ¼cÃ¼ler doÄŸru tip ve eriÅŸilebilir mi?", note:"Konum, levha, kontrol tarihi"},
  {q:"Acil Ã§Ä±kÄ±ÅŸlar aÃ§Ä±k ve kilitsiz mi?", note:"Tahliye yolu sÃ¼rekli aÃ§Ä±k"},
  {q:"Elektrik panolarÄ± Ã§evresi temiz mi?", note:"YanÄ±cÄ± birikim yok"},
  {q:"SÄ±cak iÅŸ izin sÃ¼reci uygulanÄ±yor mu?", note:"GÃ¶zcÃ¼ + kÄ±vÄ±lcÄ±m Ã¶nlemi"},
  {q:"Toplanma alanÄ± ve acil iletiÅŸim biliniyor mu?", note:"Saha bilgilendirme"},
]},
{ id:"kimyasal_detay", name:"Kimyasal - Depolama / Maruziyet Kontrol", items:[
  {q:"TÃ¼m kimyasallar etiketli ve MSDS eriÅŸilebilir mi?", note:"GÃ¼ncel MSDS"},
  {q:"Uyumsuz kimyasallar ayrÄ± depolanÄ±yor mu?", note:"Asit-baz/oksitleyici vb."},
  {q:"HavalandÄ±rma yeterli mi?", note:"KapalÄ± alanlarda kritik"},
  {q:"DÃ¶kÃ¼lme kiti ve gÃ¶z duÅŸu hazÄ±r mÄ±?", note:"MÃ¼dahale ekipmanÄ±"},
  {q:"AtÄ±k yÃ¶netimi uygun mu?", note:"Etiket, kapalÄ± kutu, prosedÃ¼r"},
]}

  ];

  function clKey(id){ return state.checklist[id] || (state.checklist[id]={}); }

  function checklistSummary(id){
    const c = checklists.find(x=>x.id===id);
    const a = clKey(id);
    const keys = Object.keys(a);
    let ok=0, bad=0, na=0;
    keys.forEach(k=>{
      if(a[k]==="ok") ok++;
      if(a[k]==="bad") bad++;
      if(a[k]==="na") na++;
    });
    return {ok,bad,na,total: c.items.length};
  }

  function renderChecklistItems(id){
    const c = checklists.find(x=>x.id===id) || checklists[0];
    const answers = clKey(c.id);
    const query = $("clSearch").value.trim().toLowerCase();

    const box = $("clItems");
    box.innerHTML = "";

    const filtered = c.items
      .map((it, idx)=>({it, idx}))
      .filter(x=>{
        if(!query) return true;
        return (`${x.it.q} ${x.it.note||""}`.toLowerCase()).includes(query);
      });

    if(filtered.length===0){
      box.innerHTML = `<div class="hint">Aramaya uygun madde bulunamadÄ±.</div>`;
      return;
    }

    filtered.forEach(({it, idx})=>{
      const v = answers[idx] || "ok";
      const div = document.createElement("div");
      div.className = "k";
      div.innerHTML = `
        <div style="display:flex;gap:10px;align-items:flex-start;justify-content:space-between">
          <div>
            <div style="font-weight:1000">${idx+1}. ${escapeHtml(it.q)}</div>
            <div class="hint">${escapeHtml(it.note||"")}</div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
            <button class="btn ${v==='ok'?'good':''}" data-v="ok" data-i="${idx}">Uygun</button>
            <button class="btn ${v==='na'?'primary':''}" data-v="na" data-i="${idx}">Uygulanmaz</button>
            <button class="btn ${v==='bad'?'danger':''}" data-v="bad" data-i="${idx}">Uygunsuz</button>
          </div>
        </div>`;
      div.querySelectorAll("button").forEach(b=>{
        b.addEventListener("click", ()=>{
          answers[idx] = b.dataset.v;
          save();
          renderChecklistItems(c.id);
        });
      });
      box.appendChild(div);
      box.appendChild(document.createElement("div")).className="hr";
    });

    const hrs = box.querySelectorAll(".hr");
    if(hrs.length) hrs[hrs.length-1].remove();
  }

  function renderChecklists(){
    const sel = $("clSelect");
    sel.innerHTML = "";
    checklists.forEach(c=>{
      const o = document.createElement("option");
      o.value=c.id; o.textContent=c.name;
      sel.appendChild(o);
    });

    const last = state.meta.lastChecklist || checklists[0].id;
    sel.value = last;
    renderChecklistItems(last);
    renderTemplates();

    sel.onchange = ()=>{
      state.meta.lastChecklist = sel.value;
      save();
      renderChecklistItems(sel.value);
    };
  }

  $("clSearch").addEventListener("input", debounce(()=>renderChecklistItems($("clSelect").value), 180));

  $("resetChecklist").addEventListener("click", ()=>{
    const id = $("clSelect").value;
    if(!confirm("Bu kontrol listesindeki iÅŸaretlemeleri sÄ±fÄ±rlamak istiyor musun?")) return;
    state.checklist[id] = {};
    save();
    renderChecklistItems(id);
    toast("Liste sÄ±fÄ±rlandÄ±");
  });

  $("quickSummary").addEventListener("click", ()=>{
    const id = $("clSelect").value;
    const s = checklistSummary(id);
    toast(`Ã–zet: Uygun ${s.ok} â€¢ Uygunsuz ${s.bad} â€¢ Uygulanmaz ${s.na}`);
  });

  $("addFailedToFindings").addEventListener("click", ()=>{
    pullMeta();
    const id = $("clSelect").value;
    const c = checklists.find(x=>x.id===id);
    const answers = clKey(id);
    const badIdx = Object.keys(answers).filter(k=>answers[k]==="bad").map(Number);
    if(!badIdx.length){ toast("Uygunsuz iÅŸaretli madde yok"); return; }

    let added = 0;
    badIdx.forEach(idx=>{
      const it = c.items[idx];
      const now = new Date().toISOString();
      const desc = `[Kontrol Listesi] ${c.name} / Madde ${idx+1}: ${it.q} (${it.note||""})`.trim();
      const p=3, s=3, score=p*s;
      state.findings.unshift({
        id: uid(),
        createdAt: now,
        updatedAt: now,
        meta: {...state.meta},
        cat: "Kontrol Listesi",
        loc: state.meta.siteDept || "",
        desc,
        control: "Uygunsuzluk giderilene kadar aksiyon planÄ± oluÅŸtur ve sorumlu ata.",
        p,s,score,level:riskLevel(score),
        owner:"",
        due:"",
        status:"open",
        photo:""
      });
      added++;
    });

    save();
    renderDashboard();
    renderRecent();
    toast(`${added} madde bulguya eklendi`);
  });

  // ===== Tools: Toolbox talk =====
  const TOOLBOX_BANK = {
    "YÃ¼ksekte Ã‡alÄ±ÅŸma":[
      "Toplu koruma (korkuluk/kapak/aÄŸ) kontrol edildi mi?",
      "Emniyet kemeri baÄŸlantÄ± noktasÄ± uygun mu (ankraj)?",
      "Hava ÅŸartlarÄ± (rÃ¼zgar/yaÄŸÄ±ÅŸ) deÄŸerlendirmesi yapÄ±ldÄ± mÄ±?",
      "DÃ¼ÅŸen cisim riski iÃ§in alan izolasyonu var mÄ±?",
      "Merdiven/iskeleden gÃ¼venli iniÅŸ-Ã§Ä±kÄ±ÅŸ saÄŸlandÄ± mÄ±?"
    ],
    "Elektrik":[
      "GeÃ§ici panolar kilitli ve kaÃ§ak akÄ±m rÃ¶lesi (RCD) Ã§alÄ±ÅŸÄ±r mÄ±?",
      "Kablolarda ezilme, ek, izolasyon hasarÄ± var mÄ±?",
      "Enerji izolasyonu/LOTO ihtiyacÄ± var mÄ±?",
      "Yetkisiz mÃ¼dahaleyi engelleyen Ã¶nlem var mÄ±?",
      "Islak alanda elektrikli ekipman kullanÄ±mÄ± kontrol edildi mi?"
    ],
    "Elle TaÅŸÄ±ma":[
      "YÃ¼k aÄŸÄ±rlÄ±ÄŸÄ±/mesafe/pozisyon deÄŸerlendirildi mi?",
      "Uygun ekipman (transpalet, el arabasÄ±) kullanÄ±lÄ±yor mu?",
      "Bel-bacak tekniÄŸi hatÄ±rlatÄ±ldÄ± mÄ± (dizden gÃ¼Ã§ alma)?",
      "Tek kiÅŸi yerine ekip taÅŸÄ±masÄ± gerekir mi?",
      "Zemin ve geÃ§iÅŸ yolu uygun mu?"
    ],
    "KaldÄ±rma OperasyonlarÄ±":[
      "Sapan/aksesuarlarÄ±n durumu uygun mu (etiket, yÄ±pranma)?",
      "Alan izolasyonu ve iÅŸaretÃ§i/gÃ¶zcÃ¼ var mÄ±?",
      "YÃ¼k altÄ±na girilmeme kuralÄ± hatÄ±rlatÄ±ldÄ± mÄ±?",
      "RÃ¼zgar/denge/baÄŸlama noktalarÄ± kontrol edildi mi?",
      "OperatÃ¶r yetkinliÄŸi ve izinler uygun mu?"
    ],
    "Kimyasal":[
      "Etiket ve MSDS eriÅŸimi var mÄ±?",
      "Uygun KKD (gÃ¶zlÃ¼k, eldiven, maske) seÃ§ildi mi?",
      "HavalandÄ±rma ve dÃ¶kÃ¼lme kiti hazÄ±r mÄ±?",
      "Uyumsuz kimyasal birlikte depolanmÄ±yor mu?",
      "AtÄ±k/boÅŸ ambalaj yÃ¶netimi konuÅŸuldu mu?"
    ],
    "YangÄ±n":[
      "SÄ±cak iÅŸ varsa izin ve Ã¶nlemler tamam mÄ±?",
      "YangÄ±n tÃ¼pÃ¼ eriÅŸimi aÃ§Ä±k mÄ±, kontrol tarihi gÃ¼ncel mi?",
      "Acil Ã§Ä±kÄ±ÅŸlar aÃ§Ä±k mÄ±, toplanma alanÄ± biliniyor mu?",
      "Sigara alanÄ± ve kÄ±vÄ±lcÄ±m kaynaklarÄ± kontrol edildi mi?",
      "Elektrik/yanÄ±cÄ± malzeme kaynaklÄ± riskler gÃ¶zden geÃ§irildi mi?"
    ],
    "Ä°skele / Platform":[
      "Kurulum sonrasÄ± yetkili kontrol ve etiket var mÄ±?",
      "Taban, ankraj, Ã§apraz baÄŸlantÄ±lar uygun mu?",
      "Platform Ã¼zeri dÃ¼zenli mi (malzeme dÃ¼ÅŸme riski)?",
      "GÃ¼venli eriÅŸim (merdiven/kapÄ±) saÄŸlandÄ± mÄ±?",
      "Hava ÅŸartlarÄ±na gÃ¶re kullanÄ±m uygun mu?"
    ],
    "Genel Saha Disiplini":[
      "YÃ¼rÃ¼yÃ¼ÅŸ yollarÄ± ve dÃ¼zen (5S) kontrol edildi mi?",
      "KKD kullanÄ±mÄ± iÅŸin riskine uygun mu?",
      "Alan izolasyonu/uyarÄ± levhalarÄ± yeterli mi?",
      "Yeni baÅŸlayanlara sahaya Ã¶zel riskler anlatÄ±ldÄ± mÄ±?",
      "GÃ¶zlemlenen tehlike anÄ±nda bildirilecek mi?"
    ]
  };

  function renderTools(){
    $("thrLow").value = state.thresholds.lowMax;
    $("thrMid").value = state.thresholds.midMax;
    updateQuickRisk();
  }

  function genToolboxText(topic, note){
    const meta = state.meta || {};
    const site = meta.siteName || "-";
    const dept = meta.siteDept || "-";
    const date = meta.siteDate || todayISO();
    const points = (TOOLBOX_BANK[topic] || TOOLBOX_BANK["Genel Saha Disiplini"]).slice();
    const extra = note ? `Ek not: ${note}` : "";
    return [
      `TOOLBOX TALK (5 dk) â€¢ ${date}`,
      `Ä°ÅŸyeri/Åantiye: ${site} â€¢ Birim: ${dept}`,
      `Konu: ${topic}`,
      "",
      "BugÃ¼n hatÄ±rlatmalar:",
      ...points.map(p=>`â€¢ ${p}`),
      extra ? `â€¢ ${extra}` : "",
      "",
      "KatÄ±lÄ±m: Ad Soyad / Ä°mza"
    ].filter(Boolean).join("\n");
  }

  $("genToolbox").addEventListener("click", ()=>{
    pullMeta();
    const topic = $("tbTopic").value;
    const note = $("tbNote").value.trim();
    $("tbOut").value = genToolboxText(topic, note);
    toast("Toolbox metni hazÄ±r");
  });
  $("copyToolbox").addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText($("tbOut").value || "");
      toast("KopyalandÄ±");
    }catch(e){
      toast("Kopyalama engellendi");
    }
  });

  // Threshold actions
  $("saveThresholds").addEventListener("click", ()=>{
    const lowMax = clamp(Number($("thrLow").value||DEFAULT_THRESH.lowMax),1,25);
    const midMax = clamp(Number($("thrMid").value||DEFAULT_THRESH.midMax),1,25);
    if(midMax < lowMax){ toast("Orta max, dÃ¼ÅŸÃ¼k max'tan kÃ¼Ã§Ã¼k olamaz"); return; }
    state.thresholds.lowMax = lowMax;
    state.thresholds.midMax = midMax;
    save();
    updateRiskTag();
    updateQuickRisk();
    renderDashboard();
    toast("EÅŸikler kaydedildi");
  });
  $("resetThresholds").addEventListener("click", ()=>{
    state.thresholds = {...DEFAULT_THRESH};
    save();
    renderTools();
    updateRiskTag();
    renderDashboard();
    toast("VarsayÄ±lan eÅŸikler");
  });

  // ===== Export/Import =====
  function serialize(){ return JSON.stringify(state, null, 2); }
  function renderExportPreview(){ $("exportPreview").value = serialize(); }

  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }
  function csvEscape(v){
    const s = String(v ?? "");
    if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }

  $("exportJson").addEventListener("click", ()=>{
    const blob = new Blob([serialize()], {type:"application/json"});
    downloadBlob(blob, `isg-yedek-${todayISO()}.json`);
    toast("JSON indirildi");
  });
  $("exportCsv").addEventListener("click", ()=>{
    const rows = [
      ["id","createdAt","status","score","level","cat","loc","desc","control","owner","due","siteName","siteDept","auditor","siteDate"]
    ];
    state.findings.forEach(f=>{
      rows.push([
        f.id, f.createdAt, f.status, f.score, f.level, f.cat, f.loc, f.desc, f.control, f.owner, f.due,
        (f.meta&&f.meta.siteName)||"", (f.meta&&f.meta.siteDept)||"", (f.meta&&f.meta.auditor)||"", (f.meta&&f.meta.siteDate)||""
      ]);
    });
    const csv = rows.map(r=>r.map(cell=>csvEscape(cell)).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    downloadBlob(blob, `isg-aksiyonlar-${todayISO()}.csv`);
    toast("CSV indirildi");
  });
  $("copyJson").addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(serialize());
      toast("JSON kopyalandÄ±");
    }catch(e){
      toast("Kopyalama engellendi");
    }
  });

  $("importJson").addEventListener("click", ()=>{
    const txt = $("importBox").value.trim();
    if(!txt){ toast("JSON boÅŸ"); return; }
    let incoming;
    try{ incoming = JSON.parse(txt); }catch(e){ toast("JSON okunamadÄ±"); return; }
    if(!incoming || typeof incoming!=="object"){ toast("GeÃ§ersiz JSON"); return; }

    if(!incoming.meta) incoming.meta = {};
    if(!incoming.brand) incoming.brand = {};
    if(!incoming.thresholds) incoming.thresholds = {...DEFAULT_THRESH};
    if(!Array.isArray(incoming.findings)) incoming.findings = [];
    if(!incoming.checklist) incoming.checklist = {};
    if(!Array.isArray(incoming.userTemplates)) incoming.userTemplates = [];

    // merge meta (keep current if filled)
    state.meta = {...incoming.meta, ...state.meta};
    state.brand = {...incoming.brand, ...state.brand};
    state.thresholds = {...incoming.thresholds, ...state.thresholds};

    // merge findings by id
    const existing = new Set(state.findings.map(f=>f.id));
    let added=0;
    incoming.findings.forEach(f=>{
      if(!f || !f.id) return;
      if(existing.has(f.id)) return;
      state.findings.push(f);
      added++;
    });

    // merge checklist
    state.checklist = {...incoming.checklist, ...state.checklist};

    // merge templates (by id)
    const tplExisting = new Set((state.userTemplates||[]).map(t=>t.id));
    incoming.userTemplates.forEach(t=>{
      if(!t || !t.id) return;
      if(tplExisting.has(t.id)) return;
      state.userTemplates.push(t);
    });

    // normalize
    state.findings.sort((a,b)=>(b.createdAt||"").localeCompare(a.createdAt||""));

    save();
    syncMeta();
    applyExpertToHeader();
    renderDashboard(); renderRecent(); renderActions(); renderExportPreview();
    toast(`${added} kayÄ±t iÃ§e aktarÄ±ldÄ±`);
  });

  $("wipeAll").addEventListener("click", ()=>{
    if(!confirm("TÃ¼m kayÄ±tlar silinecek. Emin misin?")) return;
    localStorage.removeItem(KEY);
    state = load(); // will return defaults
    syncMeta();
    applyExpertToHeader();
    clearFindingForm();
    renderDashboard(); renderRecent(); renderActions(); renderExportPreview();
    toast("TÃ¼m kayÄ±tlar silindi");
  });

  // ===== Settings (Brand + Templates) =====
  function renderSettings(){
    // Expert
    const ex = (state.meta && state.meta.expert) ? state.meta.expert : {};
    if($("expName")) $("expName").value = ex.name || "";
    if($("expClass")) $("expClass").value = (ex.cls || "B").toUpperCase();
    if($("expCert")) $("expCert").value = ex.cert || "";
    if($("expOrg")) $("expOrg").value = ex.org || "";
    if($("expContact")) $("expContact").value = ex.contact || "";

    $("brandTitle").value = state.brand.title || "";
    // logo is file input; can't set value
    // templates inputs
    $("tName").value = "";
    $("tCat").value = "";
    $("tDesc").value = "";
    $("tCtrl").value = "";
    $("tP").value = "3";
    $("tS").value = "3";
    renderUserTplList();
    renderTemplates();
  }

  async function readLogo(file){
    if(!file) return "";
    return await readAsDataURL(file, 220);
  }


  // Expert save/clear
  function pullExpertFromSettings(){
    if(!state.meta) state.meta = {};
    if(!state.meta.expert) state.meta.expert = {};
    state.meta.expert.name = ($("expName")?.value || "").trim();
    state.meta.expert.cls  = ($("expClass")?.value || "B").trim().toUpperCase();
    state.meta.expert.cert = ($("expCert")?.value || "").trim();
    state.meta.expert.org  = ($("expOrg")?.value || "").trim();
    state.meta.expert.contact = ($("expContact")?.value || "").trim();
    save();
    applyExpertToHeader();
  }
  $("saveExpert")?.addEventListener("click", ()=>{
    pullExpertFromSettings();
    toast("Uzman bilgileri kaydedildi");
  });
  $("clearExpert")?.addEventListener("click", ()=>{
    if(!state.meta) state.meta = {};
    state.meta.expert = {};
    save();
    renderSettings();
    applyExpertToHeader();
    toast("Uzman bilgileri temizlendi");
  });

  $("saveBrand").addEventListener("click", async ()=>{
    const title = $("brandTitle").value.trim();
    const file = $("brandLogo").files && $("brandLogo").files[0];
    const logo = file ? await readLogo(file) : (state.brand.logo || "");
    state.brand = { title, logo };
    save();
    applyBrand();
    toast("Kaydedildi");
  });

  $("clearBrand").addEventListener("click", ()=>{
    state.brand = {};
    save();
    applyBrand();
    $("brandTitle").value = "";
    $("brandLogo").value = "";
    toast("Temizlendi");
  });

  function renderUserTplList(){
    const box = $("userTplList");
    const list = state.userTemplates || [];
    if(!list.length){
      box.className="hint";
      box.textContent="HenÃ¼z Ã¶zel ÅŸablon yok.";
      return;
    }
    box.className="";
    box.innerHTML = list.map(t=>{
      const score = (t.p||3)*(t.s||3);
      return `
        <div class="k">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
            <div>
              <div style="font-weight:1000">${escapeHtml(t.title)}</div>
              <div class="hint">${escapeHtml(t.cat)} â€¢ Risk: ${score}</div>
            </div>
            <button class="btn danger" data-del="${t.id}">Sil</button>
          </div>
        </div>`;
    }).join('<div class="hr"></div>');

    box.querySelectorAll("button").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.dataset.del;
        if(!confirm("Bu ÅŸablonu silmek istiyor musun?")) return;
        state.userTemplates = (state.userTemplates||[]).filter(x=>x.id!==id);
        save();
        renderUserTplList();
        renderTemplates();
        toast("Åablon silindi");
      });
    });
  }

  $("addTemplate").addEventListener("click", ()=>{
    const title = $("tName").value.trim();
    const cat = $("tCat").value.trim() || "Genel";
    const desc = $("tDesc").value.trim();
    const control = $("tCtrl").value.trim();
    const p = Number($("tP").value);
    const s = Number($("tS").value);

    if(!title || !desc){
      toast("Åablon adÄ± ve bulgu gerekli");
      return;
    }
    const t = { id: uid(), title, cat, loc:"", desc, control, p, s };
    state.userTemplates.unshift(t);
    save();
    renderUserTplList();
    renderTemplates();
    toast("Åablon eklendi");
    $("tName").value="";
    $("tCat").value="";
    $("tDesc").value="";
    $("tCtrl").value="";
    $("tP").value="3";
    $("tS").value="3";
  });

  $("resetTemplates").addEventListener("click", ()=>{
    if(!confirm("Ã–zel ÅŸablonlarÄ± temizleyip varsayÄ±lanlara dÃ¶nmek istiyor musun?")) return;
    state.userTemplates = [];
    save();
    renderUserTplList();
    renderTemplates();
    toast("VarsayÄ±lan ÅŸablonlar");
  });

  function applyBrand(){
    // Update header title if provided
    const title = state.brand && state.brand.title ? state.brand.title : "Ä°SG Saha AsistanÄ± â€¢ Pro";
    document.title = title;
    document.querySelector(".title h1").textContent = title;

    // Update logo if provided
    const logoEl = document.querySelector(".logo");
    if(state.brand && state.brand.logo){
      logoEl.style.background = `url(${state.brand.logo}) center/cover no-repeat`;
    }else{
      logoEl.style.background = "linear-gradient(135deg, rgba(122,167,255,.95), rgba(49,208,127,.9))";
    }
  }

  // ===== Print / PDF =====
  function printReport(){
    pullMeta();
    const w = window.open("", "_blank");
    const meta = state.meta||{};
    const rows = state.findings.slice().sort((a,b)=>(b.createdAt||"").localeCompare(a.createdAt||""));
    const brandTitle = (state.brand && state.brand.title) ? state.brand.title : "Ä°SG Saha AsistanÄ±";
    const sig = "Fatih AKDENÄ°Z  |  Ä°Å GÃœVENLÄ°ÄÄ° UZMANI (B)  |  HAZIRLAYAN";

    const html = `
<!doctype html><html lang="tr"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ä°SG Rapor</title>
<style>
  body{font-family:Arial, sans-serif;margin:24px;color:#111}
  h1{margin:0 0 6px 0;font-size:18px}
  .sub{color:#444;margin-bottom:14px}
  .box{border:1px solid #ddd;border-radius:10px;padding:12px;margin:10px 0}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #ddd;padding:8px;font-size:12px;vertical-align:top}
  th{background:#f5f5f5}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:700;font-size:11px;border:1px solid #ddd}
  .low{background:#e8fff1}
  .mid{background:#fff6e6}
  .high{background:#ffe8e8}
  .sig{margin-top:14px;font-size:12px;color:#333}
  img{max-width:180px;max-height:120px;border:1px solid #ddd;border-radius:8px}
  @media print{ button{display:none} }
</style>
</head><body>
  <h1>${escapeHtml(brandTitle)} - Bulgu / Aksiyon Raporu</h1>
  <div class="sub">${escapeHtml(meta.siteName||"-")} â€¢ ${escapeHtml(meta.siteDept||"-")} â€¢ Tarih: ${escapeHtml(meta.siteDate||todayISO())}</div>
  <div class="box">
    <b>Denetimi Yapan:</b> ${escapeHtml(meta.auditor||"-")}<br/>
    <b>Toplam Bulgu:</b> ${rows.length} â€¢ <b>AÃ§Ä±k:</b> ${rows.filter(r=>r.status!=="done").length} â€¢ <b>GecikmiÅŸ:</b> ${rows.filter(r=>isOverdue(r.due,r.status)).length}
  </div>

  <table>
    <thead>
      <tr>
        <th>Durum</th><th>Risk</th><th>Kategori</th><th>Lokasyon</th><th>Bulgu</th><th>Ã–neri</th><th>Sorumlu</th><th>Termin</th><th>Foto</th>
      </tr>
    </thead>
    <tbody>
      ${rows.map(r=>{
        const cls = r.level==="high"?"high":(r.level==="mid"?"mid":"low");
        const st = r.status==="done"?"KapalÄ±":"AÃ§Ä±k";
        const img = r.photo ? `<img alt="foto" src="${r.photo}"/>` : "";
        return `<tr>
          <td>${st}</td>
          <td><span class="tag ${cls}">${r.score} â€¢ ${riskText(r.level)}</span></td>
          <td>${escapeHtml(r.cat||"")}</td>
          <td>${escapeHtml(r.loc||"")}</td>
          <td>${escapeHtml(r.desc||"")}</td>
          <td>${escapeHtml(r.control||"")}</td>
          <td>${escapeHtml(r.owner||"")}</td>
          <td>${escapeHtml(r.due||"")}</td>
          <td>${img}</td>
        </tr>`;
      }).join("")}
    </tbody>
  </table>

  <div class="sig"><b>${escapeHtml(sig)}</b></div>
  <button onclick="window.print()">YazdÄ±r / PDF</button>
</body></html>`;
    w.document.open();
    w.document.write(html);
    w.document.close();
  }

  // ===== Dashboard quick nav =====
  $("goNewFinding").addEventListener("click", ()=>setActive("newFinding"));
  $("goChecklists").addEventListener("click", ()=>setActive("checklists"));

  
// ===== Near Miss (Ramak Kala) =====
let nmPhotoData = "";
$("nmPhoto").addEventListener("change", async (e)=>{
  nmPhotoData = "";
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  nmPhotoData = await readAsDataURL(file, 1100);
  toast("FotoÄŸraf eklendi");
});

function clearNearMissForm(){
  $("nmDate").value = todayISO();
  $("nmLoc").value = "";
  $("nmDesc").value = "";
  $("nmCons").value = "Ä°lk yardÄ±m gerektirmeyen";
  $("nmType").value = "DiÄŸer";
  $("nmImmediate").value = "";
  $("nmRoot").value = "";
  $("nmOwner").value = "";
  $("nmDue").value = "";
  $("nmPhoto").value = "";
  nmPhotoData = "";
}
$("clearNearMiss").addEventListener("click", ()=>{
  clearNearMissForm(); toast("Form temizlendi");
});


  // ===== Notes =====
  function syncNoteForm(){
    $("noteDate").value = todayISO();
    $("noteTag").value = "";
    $("noteTitle").value = "";
    $("noteBody").value = "";
  }
  function renderNotes(){
    if(!$("noteDate")) return;
    if(!$("noteDate").value) $("noteDate").value = todayISO();

    const list = $("noteRecent");
    const items = (state.notes || []).slice().sort((a,b)=> (b.date||"").localeCompare(a.date||"") || (b.createdAt||"").localeCompare(a.createdAt||""));
    if(!items.length){
      list.innerHTML = "HenÃ¼z not yok.";
      list.className = "hint";
      return;
    }
    list.className = "";
    list.innerHTML = "";
    items.slice(0,25).forEach(n=>{
      const box = document.createElement("div");
      box.className = "k";
      box.innerHTML = `
        <div style="display:flex;gap:10px;align-items:flex-start;justify-content:space-between">
          <div style="min-width:0">
            <div style="font-weight:1000">${escapeHtml(n.title||"(BaÅŸlÄ±ksÄ±z)")}</div>
            <div class="hint" style="margin-top:4px">${escapeHtml(n.date||"")} ${n.tag?("â€¢ "+escapeHtml(n.tag)):""}</div>
            <div class="hint" style="margin-top:8px;white-space:pre-wrap">${escapeHtml(n.body||"")}</div>
          </div>
          <button class="btn danger" data-id="${escapeHtml(n.id)}">Sil</button>
        </div>`;
      box.querySelector("button").addEventListener("click", ()=>{
        state.notes = (state.notes||[]).filter(x=>x.id!==n.id);
        save();
        renderNotes();
        toast("Not silindi");
      });
      list.appendChild(box);
      list.appendChild(document.createElement("div")).className="hr";
    });
    const hrs = list.querySelectorAll(".hr");
    if(hrs.length) hrs[hrs.length-1].remove();
  }

  $("saveNote")?.addEventListener("click", ()=>{
    const date = $("noteDate").value || todayISO();
    const tag  = $("noteTag").value.trim();
    const title= $("noteTitle").value.trim();
    const body = $("noteBody").value.trim();
    if(!body && !title){ toast("Not boÅŸ olamaz"); return; }
    const n = { id: uid(), date, tag, title, body, createdAt: new Date().toISOString() };
    state.notes = state.notes || [];
    state.notes.push(n);
    save();
    renderNotes();
    toast("Not kaydedildi");
  });
  $("clearNote")?.addEventListener("click", ()=>{ syncNoteForm(); toast("Temizlendi"); });
  $("copyNote")?.addEventListener("click", async ()=>{
    const txt = `Tarih: ${$("noteDate").value||todayISO()}\nEtiket: ${$("noteTag").value.trim()}\nBaÅŸlÄ±k: ${$("noteTitle").value.trim()}\n\n${$("noteBody").value}`;
    try{ await navigator.clipboard.writeText(txt); toast("KopyalandÄ±"); }catch(e){ toast("Kopyalama engellendi"); }
  });
  $("printNotes")?.addEventListener("click", ()=>{ window.print(); });

$("saveNearMiss").addEventListener("click", ()=>{
  pullMeta();
  const date = $("nmDate").value || todayISO();
  const loc = $("nmLoc").value.trim();
  const desc = $("nmDesc").value.trim();
  const cons = $("nmCons").value;
  const type = $("nmType").value;
  const immediate = $("nmImmediate").value.trim();
  const root = $("nmRoot").value.trim();
  const owner = $("nmOwner").value.trim();
  let due = $("nmDue").value || "";
  if(!desc){ toast("Olay tanÄ±mÄ± boÅŸ olamaz"); return; }
  if(!due){ due = addDays(date, 7); } // default follow-up 7 gÃ¼n
  const now = new Date().toISOString();
  state.nearMisses.unshift({
    id: uid(), createdAt: now, updatedAt: now,
    meta: {...state.meta},
    date, loc, desc, cons, type, immediate, root, owner, due,
    status: "open",
    photo: nmPhotoData || ""
  });
  save();
  renderNearMissRecent();
  renderDashboard();
  toast("Kaydedildi");
  // clear some fields
  $("nmDesc").value=""; $("nmImmediate").value=""; $("nmRoot").value="";
  $("nmPhoto").value=""; nmPhotoData="";
});

function renderNearMissRecent(){
  const box = $("nmRecent");
  const list = (state.nearMisses||[]).slice(0,6);
  if(!list.length){ box.className="hint"; box.textContent="HenÃ¼z kayÄ±t yok."; return; }
  box.className="";
  box.innerHTML = list.map(n=>{
    const overdue = isOverdue(n.due, n.status);
    return `
      <div class="k">
        <div style="display:flex;gap:10px;align-items:flex-start;justify-content:space-between">
          <div>
            <div class="row" style="gap:8px">
              <span class="badge">${escapeHtml(n.type)}</span>
              <span class="badge">${escapeHtml(n.cons)}</span>
              ${n.photo ? '<span class="badge">ğŸ“· foto</span>' : ''}
              ${overdue ? '<span class="badge" style="border-color:rgba(255,107,107,.55);color:var(--bad)">gecikmiÅŸ</span>' : ''}
            </div>
            <div style="font-weight:1000;margin-top:8px">${escapeHtml(shorten(n.desc,120))}</div>
            <div class="hint" style="margin-top:6px">ğŸ“ ${escapeHtml(n.loc||"-")} â€¢ ğŸ“… ${escapeHtml(n.date)} â€¢ ğŸ‘¤ ${escapeHtml(n.owner||"-")} â€¢ â³ ${escapeHtml(n.due||"-")}</div>
            ${n.root ? `<div class="hint" style="margin-top:8px"><b>KÃ¶k neden:</b> ${escapeHtml(shorten(n.root,170))}</div>` : ``}
            ${n.photo ? `<div style="margin-top:10px"><img alt="foto" src="${n.photo}" style="max-width:100%;border-radius:16px;border:1px solid var(--line)"></div>` : ``}
          </div>
          <div class="row">
            <button class="btn" data-act="toggle" data-id="${n.id}">${n.status==="done"?"AÃ§":"Kapat"}</button>
            <button class="btn danger" data-act="del" data-id="${n.id}">Sil</button>
          </div>
        </div>
      </div>`;
  }).join('<div class="hr"></div>');

  box.querySelectorAll("button").forEach(b=>{
    b.addEventListener("click", ()=>{
      const id = b.dataset.id;
      const act = b.dataset.act;
      if(act==="del"){
        if(!confirm("Bu kaydÄ± silmek istiyor musun?")) return;
        state.nearMisses = (state.nearMisses||[]).filter(x=>x.id!==id);
        save();
        renderNearMissRecent(); renderDashboard();
        toast("Silindi");
      }else{
        const n = (state.nearMisses||[]).find(x=>x.id===id);
        if(!n) return;
        n.status = (n.status==="done" ? "open" : "done");
        n.updatedAt = new Date().toISOString();
        save();
        renderNearMissRecent(); renderDashboard();
        toast(n.status==="done" ? "KapandÄ±" : "AÃ§Ä±ldÄ±");
      }
    });
  });
}

// ===== Trainings / Meetings =====
let trPhotoData = "";
$("trPhoto").addEventListener("change", async (e)=>{
  trPhotoData = "";
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  trPhotoData = await readAsDataURL(file, 1100);
  toast("FotoÄŸraf eklendi");
});

function clearTrainingForm(){
  $("trDate").value = todayISO();
  $("trType").value = "Toolbox Talk";
  $("trTopic").value = "";
  $("trTrainer").value = "";
  $("trCount").value = "";
  $("trMin").value = "";
  $("trLoc").value = "";
  $("trNotes").value = "";
  $("trPhoto").value = "";
  trPhotoData = "";
}
$("clearTraining").addEventListener("click", ()=>{ clearTrainingForm(); toast("Form temizlendi"); });

$("saveTraining").addEventListener("click", ()=>{
  pullMeta();
  const date = $("trDate").value || todayISO();
  const type = $("trType").value;
  const topic = $("trTopic").value.trim();
  const trainer = $("trTrainer").value.trim();
  const count = Number($("trCount").value||0);
  const mins = Number($("trMin").value||0);
  const loc = $("trLoc").value.trim();
  const notes = $("trNotes").value.trim();
  if(!topic){ toast("Konu boÅŸ olamaz"); return; }
  const now = new Date().toISOString();
  state.trainings.unshift({
    id: uid(), createdAt: now, updatedAt: now,
    meta: {...state.meta},
    date, type, topic, trainer, count, mins, loc, notes,
    photo: trPhotoData || ""
  });
  save();
  renderTrainingRecent();
  renderDashboard();
  toast("Kaydedildi");
  $("trTopic").value=""; $("trNotes").value=""; $("trPhoto").value=""; trPhotoData="";
});

function renderTrainingRecent(){
  const box = $("trRecent");
  const list = (state.trainings||[]).slice(0,7);
  if(!list.length){ box.className="hint"; box.textContent="HenÃ¼z kayÄ±t yok."; return; }
  box.className="";
  box.innerHTML = list.map(t=>{
    return `
      <div class="k">
        <div style="display:flex;gap:10px;align-items:flex-start;justify-content:space-between">
          <div>
            <div class="row" style="gap:8px">
              <span class="badge">${escapeHtml(t.type)}</span>
              <span class="badge">ğŸ“… ${escapeHtml(t.date)}</span>
              ${t.count ? `<span class="badge">ğŸ‘¥ ${t.count}</span>` : ''}
              ${t.mins ? `<span class="badge">â±ï¸ ${t.mins} dk</span>` : ''}
              ${t.photo ? '<span class="badge">ğŸ“· foto</span>' : ''}
            </div>
            <div style="font-weight:1000;margin-top:8px">${escapeHtml(shorten(t.topic,140))}</div>
            <div class="hint" style="margin-top:6px">ğŸ“ ${escapeHtml(t.loc||"-")} â€¢ ğŸ‘¤ ${escapeHtml(t.trainer||"-")}</div>
            ${t.notes ? `<div class="hint" style="margin-top:8px"><b>Not:</b> ${escapeHtml(shorten(t.notes,170))}</div>` : ``}
            ${t.photo ? `<div style="margin-top:10px"><img alt="foto" src="${t.photo}" style="max-width:100%;border-radius:16px;border:1px solid var(--line)"></div>` : ``}
          </div>
          <div class="row">
            <button class="btn danger" data-del="${t.id}">Sil</button>
          </div>
        </div>
      </div>`;
  }).join('<div class="hr"></div>');

  box.querySelectorAll("button").forEach(b=>{
    b.addEventListener("click", ()=>{
      const id = b.dataset.del;
      if(!confirm("Bu kaydÄ± silmek istiyor musun?")) return;
      state.trainings = (state.trainings||[]).filter(x=>x.id!==id);
      save();
      renderTrainingRecent(); renderDashboard();
      toast("Silindi");
    });
  });
}

function printTrainingSheet(){
  pullMeta();
  const meta = state.meta||{};
  const topic = $("trTopic").value.trim() || "â€”";
  const date = $("trDate").value || todayISO();
  const type = $("trType").value;
  const trainer = $("trTrainer").value.trim() || "â€”";
  const loc = $("trLoc").value.trim() || "â€”";
  const mins = $("trMin").value || "â€”";
  const site = meta.siteName || "â€”";
  const dept = meta.siteDept || "â€”";
  const sig = "Fatih AKDENÄ°Z  |  Ä°Å GÃœVENLÄ°ÄÄ° UZMANI (B)  |  HAZIRLAYAN";
  const w = window.open("", "_blank");
  const html = `<!doctype html><html lang="tr"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>EÄŸitim Formu</title>
    <style>
      body{font-family:Arial, sans-serif;margin:24px;color:#111}
      h1{margin:0 0 6px 0;font-size:18px}
      .sub{color:#444;margin-bottom:14px}
      .box{border:1px solid #ddd;border-radius:10px;padding:12px;margin:10px 0}
      table{width:100%;border-collapse:collapse;margin-top:10px}
      th,td{border:1px solid #ddd;padding:8px;font-size:12px}
      th{background:#f5f5f5}
      .sig{margin-top:14px;font-size:12px;color:#333}
      @media print{ button{display:none} }
    </style></head><body>
      <h1>${escapeHtml(type)} KatÄ±lÄ±m Formu</h1>
      <div class="sub">${escapeHtml(site)} â€¢ ${escapeHtml(dept)} â€¢ Tarih: ${escapeHtml(date)}</div>
      <div class="box">
        <b>Konu:</b> ${escapeHtml(topic)}<br/>
        <b>Yer:</b> ${escapeHtml(loc)}<br/>
        <b>EÄŸitimi Veren:</b> ${escapeHtml(trainer)}<br/>
        <b>SÃ¼re:</b> ${escapeHtml(mins)} dk
      </div>
      <table>
        <thead><tr><th style="width:50px">No</th><th>Ad Soyad</th><th style="width:130px">Ä°mza</th></tr></thead>
        <tbody>
          ${Array.from({length:20}).map((_,i)=>`<tr><td>${i+1}</td><td></td><td></td></tr>`).join("")}
        </tbody>
      </table>
      <div class="sig"><b>${escapeHtml(sig)}</b></div>
      <button onclick="window.print()">YazdÄ±r / PDF</button>
    </body></html>`;
  w.document.open(); w.document.write(html); w.document.close();
}
$("printTraining").addEventListener("click", printTrainingSheet);

// ===== Equipment checks =====
const EQ_TEMPLATES = {
  "YangÄ±n TÃ¼pÃ¼":[
    "Etiket ve kontrol tarihi gÃ¼ncel mi?",
    "MÃ¼hÃ¼r/pim saÄŸlam mÄ±?",
    "BasÄ±nÃ§ gÃ¶stergesi uygun aralÄ±kta mÄ±?",
    "Hortum/nozul saÄŸlam mÄ±?",
    "EriÅŸim Ã¶nÃ¼ aÃ§Ä±k mÄ±?"
  ],
  "Emniyet Kemeri / Lanyard":[
    "Dokuma/kemer Ã¼zerinde kesik, yÄ±pranma var mÄ±?",
    "Karabina kilidi Ã§alÄ±ÅŸÄ±yor mu?",
    "Åok emici/etiketler okunuyor mu?",
    "DikiÅŸler saÄŸlam mÄ±?",
    "KullanÄ±m Ã¶mrÃ¼/seri no takip ediliyor mu?"
  ],
  "Merdiven":[
    "Basamaklar saÄŸlam mÄ±?",
    "KaydÄ±rmaz ayaklar saÄŸlam mÄ±?",
    "Hasar/Ã§atlak var mÄ±?",
    "DoÄŸru kullanÄ±m etiketi/uyarÄ± var mÄ±?",
    "Sabitlenerek kullanÄ±lÄ±yor mu?"
  ],
  "Ä°skele (GÃ¼nlÃ¼k)":[
    "Etiketleme var mÄ± (kullanÄ±ma uygun)?",
    "Platformlar saÄŸlam ve kaymaz mÄ±?",
    "Korkuluk/eteklik tam mÄ±?",
    "EriÅŸim merdiveni gÃ¼venli mi?",
    "Zemin/ankraj uygun mu?"
  ],
  "Forklift (GÃ¼nlÃ¼k)":[
    "Korna/ikaz lambalarÄ± Ã§alÄ±ÅŸÄ±yor mu?",
    "Geri vites alarmÄ± Ã§alÄ±ÅŸÄ±yor mu?",
    "Frenler ve direksiyon kontrol edildi mi?",
    "Ã‡atallar ve zincirlerde hasar var mÄ±?",
    "OperatÃ¶r kemeri takÄ±yor mu?"
  ],
  "Elektrik Panosu":[
    "Pano kilitli ve kapalÄ± mÄ±?",
    "KaÃ§ak akÄ±m rÃ¶lesi mevcut ve testli mi?",
    "Topraklama etiketi ve uyarÄ±lar var mÄ±?",
    "Kablo giriÅŸleri korumalÄ± mÄ±?",
    "YanÄ±cÄ± malzeme birikimi yok mu?"
  ]
};

function renderEqItems(){
  const type = $("eqType").value;
  const items = EQ_TEMPLATES[type] || [];
  const box = $("eqItems");
  box.innerHTML = "";
  items.forEach((q, idx)=>{
    const div = document.createElement("div");
    div.className="k";
    div.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div style="font-weight:1000">${idx+1}. ${escapeHtml(q)}</div>
        <select data-i="${idx}" style="max-width:170px">
          <option value="Uygun">Uygun</option>
          <option value="Uygunsuz">Uygunsuz</option>
          <option value="NA">Uygulanmaz</option>
        </select>
      </div>`;
    box.appendChild(div);
    box.appendChild(document.createElement("div")).className="hr";
  });
  const hrs = box.querySelectorAll(".hr");
  if(hrs.length) hrs[hrs.length-1].remove();
}

function clearEqForm(){
  $("eqDate").value = todayISO();
  $("eqId").value = "";
  $("eqNext").value = addDays(todayISO(), 30);
  $("eqResult").value = "Uygun";
  $("eqNote").value = "";
  renderEqItems();
}
$("clearEq").addEventListener("click", ()=>{ clearEqForm(); toast("Form temizlendi"); });

$("saveEq").addEventListener("click", ()=>{
  pullMeta();
  const type = $("eqType").value;
  const id = $("eqId").value.trim();
  const date = $("eqDate").value || todayISO();
  const next = $("eqNext").value || addDays(date, 30);
  const result = $("eqResult").value;
  const note = $("eqNote").value.trim();

  // collect answers
  const ans = [];
  $("eqItems").querySelectorAll("select").forEach(sel=>{
    ans.push({qIdx:Number(sel.dataset.i), v: sel.value});
  });
  if(!type){ toast("Ekipman tÃ¼rÃ¼ seÃ§"); return; }

  const now = new Date().toISOString();
  state.equipmentChecks.unshift({
    id: uid(), createdAt: now, updatedAt: now,
    meta: {...state.meta},
    type, eqId: id, date, next, result, note,
    answers: ans
  });
  save();
  renderEqRecent();
  renderDashboard();
  toast("Kaydedildi");
  $("eqId").value=""; $("eqNote").value="";
});

function renderEqRecent(){
  const box = $("eqRecent");
  const list = (state.equipmentChecks||[]).slice(0,8);
  if(!list.length){ box.className="hint"; box.textContent="HenÃ¼z kayÄ±t yok."; return; }
  box.className="";
  box.innerHTML = list.map(e=>{
    const overdue = e.next && e.next < todayISO();
    const badCount = (e.answers||[]).filter(a=>a.v==="Uygunsuz").length;
    return `
      <div class="k">
        <div style="display:flex;gap:10px;align-items:flex-start;justify-content:space-between">
          <div>
            <div class="row" style="gap:8px">
              <span class="badge">${escapeHtml(e.type)}</span>
              ${e.eqId ? `<span class="badge"># ${escapeHtml(e.eqId)}</span>` : ''}
              <span class="badge">ğŸ“… ${escapeHtml(e.date)}</span>
              <span class="badge">â¡ï¸ ${escapeHtml(e.next||"-")}</span>
              ${overdue ? '<span class="badge" style="border-color:rgba(255,107,107,.55);color:var(--bad)">gecikmiÅŸ</span>' : ''}
              ${badCount ? `<span class="badge" style="border-color:rgba(255,204,102,.55);color:var(--warn)">uygunsuz: ${badCount}</span>` : ''}
            </div>
            <div style="font-weight:1000;margin-top:8px">${escapeHtml(e.result)}</div>
            ${e.note ? `<div class="hint" style="margin-top:8px"><b>Not:</b> ${escapeHtml(shorten(e.note,170))}</div>` : ``}
          </div>
          <div class="row">
            <button class="btn danger" data-del="${e.id}">Sil</button>
          </div>
        </div>
      </div>`;
  }).join('<div class="hr"></div>');

  box.querySelectorAll("button").forEach(b=>{
    b.addEventListener("click", ()=>{
      const id = b.dataset.del;
      if(!confirm("Bu kaydÄ± silmek istiyor musun?")) return;
      state.equipmentChecks = (state.equipmentChecks||[]).filter(x=>x.id!==id);
      save();
      renderEqRecent(); renderDashboard();
      toast("Silindi");
    });
  });
}

function initEquipment(){
  const sel = $("eqType");
  sel.innerHTML = "";
  Object.keys(EQ_TEMPLATES).forEach(k=>{
    const o = document.createElement("option");
    o.value=k; o.textContent=k;
    sel.appendChild(o);
  });
  sel.addEventListener("change", renderEqItems);
  renderEqItems();
  clearEqForm();
}

// Extend tab switch renderer
const _setActive = setActive;
setActive = function(tab){
  _setActive(tab);
  if(tab==="nearMiss") renderNearMissRecent();
  if(tab==="trainings") renderTrainingRecent();
  if(tab==="equipment") renderEqRecent();
};

// Extend dashboard KPIs with near miss and trainings count (optional)
const _renderDashboard = renderDashboard;
renderDashboard = function(){
  _renderDashboard();
  // add counts into storage tag tooltip if exists
  const nmOpen = (state.nearMisses||[]).filter(n=>n.status!=="done").length;
  const tr30 = (state.trainings||[]).filter(t=>{
    const d = t.date || "";
    return d >= addDays(todayISO(), -30);
  }).length;
  const eq30 = (state.equipmentChecks||[]).filter(e=>{
    const d = e.date || "";
    return d >= addDays(todayISO(), -30);
  }).length;
  $("storageTag").title = `Ramak kala aÃ§Ä±k: ${nmOpen} â€¢ Son 30g eÄŸitim: ${tr30} â€¢ Son 30g ekipman kontrol: ${eq30}`;
};
// ===== Init =====
  syncMeta();
    applyExpertToHeader();
  clearFindingForm();
  clearNearMissForm();
  clearTrainingForm();
  initEquipment();
  setTheme(state.meta.theme || "dark");
  applyBrand();
  updateRiskTag();
  updateQuickRisk();
  renderDashboard();
  renderRecent();

  // Default initial tab
  setActive("dashboard");
})();
</script>
</body>
</html>
